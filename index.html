<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HANA Counter Final</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #333333;
            --tap-gray: #505050;
            --text-color: #ffffff;
            --lamp-blue: #0099ff;
            --lamp-yellow: #ffcc00;
            --lamp-green: #00cc00;
            --lamp-red: #ff3333;
        }

        /* ç”»é¢ã‚¬ã‚¿ã¤ãé˜²æ­¢ */
        html, body { 
            position: fixed; width: 100%; height: 100%; 
            overflow: hidden; background: var(--bg-color); color: var(--text-color);
            font-family: sans-serif; -webkit-text-size-adjust: 100%;
        }

        body { overflow-y: auto; position: relative; }

        /* è™¹è‰²ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .rainbow {
            background: linear-gradient(to right, #ff2400, #e81d1d, #e8b21d, #1de840, #1ddde8, #2b1de8, #dd1de8, #ff2400);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow_anim 3s linear infinite;
            font-weight: bold;
        }
        @keyframes rainbow_anim { to { background-position: 200% center; } }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background: #000; position: sticky; top: 0; z-index: 100;
        }

        .container { padding: 10px 10px 100px 10px; }
        .section-title { text-align: center; margin: 15px 0 5px; font-size: 13px; color: #ccc; }

        .grid { display: grid; gap: 1px; background: #111; border: 1px solid #444; margin-bottom: 10px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        .cell {
            background: var(--card-bg); padding: 12px 2px; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            touch-action: manipulation;
        }
        .tap-active { background: #666 !important; }
        .tap-minus { background: #800000 !important; }

        .label { font-size: 11px; color: #bbb; margin-bottom: 3px; pointer-events: none; }
        .value { font-size: 22px; font-weight: bold; pointer-events: none; }
        
        /* æ•°å€¤å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ */
        .val-input {
            width: 90%; background: transparent; color: white; border: none;
            text-align: center; font-size: 22px; font-weight: bold; outline: none;
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; overflow-y: auto; padding: 15px; box-sizing: border-box;
        }
        .modal-inner { max-width: 600px; margin: 0 auto; padding-bottom: 40px; }
        .close-btn { float: right; font-size: 32px; padding: 10px; }

        /* æ¨æ¸¬ãƒãƒ¼ */
        .bar-container { display: flex; align-items: center; margin: 8px 0; font-size: 14px; }
        .bar-label { width: 45px; }
        .bar-bg { flex: 1; height: 14px; background: #222; margin: 0 10px; border-radius: 2px; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.4s; border-radius: 2px; }
        .bar-pct { width: 45px; text-align: right; }

        /* è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« */
        .detail-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 15px; }
        .detail-table th, .detail-table td { border: 1px solid #444; padding: 6px 2px; text-align: center; }
        .detail-table th { background: #222; }

        .switch-container { display: flex; align-items: center; justify-content: center; margin: 20px 0; }
        select, .toggle-btn { padding: 10px; background: #444; color: white; border: 1px solid #666; width: 100%; font-size: 16px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="header">
    <div onclick="openModal('predict-modal')" style="font-size: 24px;">ğŸ”</div>
    <div id="display-machine-name" style="font-weight: bold; border-bottom: 2px solid #fff;">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</div>
    <div onclick="openModal('setting-modal')" style="font-size: 24px;">âš™ï¸</div>
</div>

<div class="container" id="main-ui">
    </div>

<div id="setting-modal" class="modal">
    <div class="modal-inner">
        <span class="close-btn" onclick="closeModal('setting-modal')">Ã—</span>
        <h2 style="text-align:center;">è¨­å®š</h2>
        
        <p class="section-title">å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰</p>
        <div class="switch-container">
            <button id="mode-toggle" class="toggle-btn" onclick="toggleMode()">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <p class="section-title">æ©Ÿç¨®é¸æŠ</p>
        <select id="machine-select" onchange="updateMachine()">
            <option value="king">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
            <option value="new">ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
        </select>

        <p class="section-title">æ‰“ã¡å§‹ã‚</p>
        <div class="grid grid-3">
            <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><input type="number" class="val-input" id="s-g" onchange="sync()"></div>
            <div class="cell"><div class="label">BIG</div><input type="number" class="val-input" id="s-b" onchange="sync()"></div>
            <div class="cell"><div class="label">REG</div><input type="number" class="val-input" id="s-r" onchange="sync()"></div>
        </div>

        <button onclick="resetAll()" style="width:100%; margin-top:30px; padding:15px; color:red; background:#300; border:1px solid red;">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<div id="predict-modal" class="modal">
    <div class="modal-inner">
        <span class="close-btn" onclick="closeModal('predict-modal')">Ã—</span>
        <h2 style="text-align:center;">æ¨æ¸¬è¨­å®š</h2>
        
        <div id="predict-bars-ui"></div>

        <p class="section-title">è©³ç´°ãƒ‡ãƒ¼ã‚¿</p>
        <table class="detail-table">
            <tr><th>é …ç›®</th><th>å›æ•°</th><th>ç¢ºç‡</th></tr>
            <tbody id="detail-rows"></tbody>
        </table>

        <p class="section-title">ãƒ©ãƒ³ãƒ—å†…è¨³</p>
        <table class="detail-table">
            <tr><th>ç¨®é¡</th><th>é’</th><th>é»„</th><th>ç·‘</th><th>èµ¤</th><th>è™¹</th></tr>
            <tbody id="lamp-rows"></tbody>
        </table>
    </div>
</div>

<script>
    // --- å†…éƒ¨ãƒ‡ãƒ¼ã‚¿ ---
    let store = JSON.parse(localStorage.getItem('hana_pro_data')) || {
        machine: 'king',
        inputMode: 'tap', // 'tap' or 'input'
        start: { g: 0, b: 0, r: 0 },
        current: { g: 0, b: 0, r: 0, bell: 0, suika: 0, hazure: 0, retro: 0, retro_d: 0 },
        lamps: {
            big: [0,0,0,0,0],
            regS: [0,0,0,0,0],
            regT: [0,0,0,0,0]
        }
    };

    // --- è§£æå€¤ (ã‚­ãƒ³ã‚°åŸºæº–) ---
    const PARAMS = {
        king: {
            b: [292, 282, 273, 264, 252, 234],
            r: [489, 455, 422, 399, 368, 336],
            bell: [7.2, 7.15, 7.1, 7.05, 7, 6.7]
        }
    };

    function sync() {
        store.start.g = Number(document.getElementById('s-g').value);
        store.start.b = Number(document.getElementById('s-b').value);
        store.start.r = Number(document.getElementById('s-r').value);
        localStorage.setItem('hana_pro_data', JSON.stringify(store));
        buildUI();
    }

    function toggleMode() {
        store.inputMode = store.inputMode === 'tap' ? 'input' : 'tap';
        document.getElementById('mode-toggle').innerText = store.inputMode === 'tap' ? 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰' : 'æ•°å€¤å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰';
        sync();
    }

    function updateMachine() {
        store.machine = document.getElementById('machine-select').value;
        document.getElementById('display-machine-name').innerText = store.machine === 'king' ? 'ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ' : 'ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ';
        sync();
    }

    function buildUI() {
        const isTap = store.inputMode === 'tap';
        const c = store.current;
        const l = store.lamps;
        
        let html = `
            <p class="section-title">&lt;ç¾åœ¨&gt;</p>
            <div class="grid grid-3">
                ${createCell('g', 'ã‚²ãƒ¼ãƒ æ•°', c.g, 50)}
                ${createCell('b', 'BIG', c.b)}
                ${createCell('r', 'REG', c.r)}
            </div>
            <p class="section-title">&lt;é€šå¸¸æ™‚ï¼šãƒ™ãƒ«&gt;</p>
            <div class="grid">${createCell('bell', '', c.bell)}</div>
            <p class="section-title">&lt;BIGï¼šã‚¹ã‚¤ã‚«&gt;</p>
            <div class="grid">${createCell('suika', '', c.suika)}</div>
            <p class="section-title">&lt;BIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—&gt;</p>
            <div class="grid grid-5">
                ${createLampCell('big', 0, 'é’', 'var(--lamp-blue)')}
                ${createLampCell('big', 1, 'é»„', 'var(--lamp-yellow)')}
                ${createLampCell('big', 2, 'ç·‘', 'var(--lamp-green)')}
                ${createLampCell('big', 3, 'èµ¤', 'var(--lamp-red)')}
                ${createLampCell('big', 4, 'è™¹', 'rainbow')}
            </div>
            <p class="section-title">&lt;REGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—&gt;</p>
            <div class="grid grid-5">
                ${createLampCell('regS', 0, 'é’', 'var(--lamp-blue)')}
                ${createLampCell('regS', 1, 'é»„', 'var(--lamp-yellow)')}
                ${createLampCell('regS', 2, 'ç·‘', 'var(--lamp-green)')}
                ${createLampCell('regS', 3, 'èµ¤', 'var(--lamp-red)')}
                ${createLampCell('regS', 4, 'è™¹', 'rainbow')}
            </div>
            <p class="section-title">&lt;REGï¼šç­ä½“ãƒ©ãƒ³ãƒ—&gt;</p>
            <div class="grid grid-5">
                ${createLampCell('regT', 0, 'é’', 'var(--lamp-blue)')}
                ${createLampCell('regT', 1, 'é»„', 'var(--lamp-yellow)')}
                ${createLampCell('regT', 2, 'ç·‘', 'var(--lamp-green)')}
                ${createLampCell('regT', 3, 'èµ¤', 'var(--lamp-red)')}
                ${createLampCell('regT', 4, 'è™¹', 'rainbow')}
            </div>
            <p class="section-title">&lt;ãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰&gt;</p>
            <div class="grid grid-2">
                ${createCell('retro_d', 'ç™ºç”Ÿæ¡ä»¶é”æˆ', c.retro_d)}
                ${createCell('retro', 'ç™ºç”Ÿå›æ•°', c.retro)}
            </div>
            <p class="section-title">&lt;BIGï¼šç´”ãƒã‚ºãƒ¬&gt;</p>
            <div class="grid">${createCell('hazure', '', c.hazure)}</div>
        `;
        document.getElementById('main-ui').innerHTML = html;
        attachEvents();
    }

    function createCell(id, label, val, step=1) {
        if (store.inputMode === 'input') {
            return `<div class="cell"><div class="label">${label}</div><input type="number" class="val-input" value="${val}" onchange="directUpdate('${id}', this.value)"></div>`;
        }
        return `<div class="cell tap-btn" data-id="${id}" data-step="${step}"><div class="label">${label}</div><div class="value">${val}</div></div>`;
    }

    function createLampCell(type, idx, label, colorClass) {
        const val = store.lamps[type][idx];
        const colorStyle = colorClass.startsWith('var') ? `style="color:${colorClass}"` : `class="${colorClass}"`;
        if (store.inputMode === 'input') {
            return `<div class="cell"><div ${colorStyle} class="label">${label}</div><input type="number" class="val-input" value="${val}" onchange="directUpdateLamp('${type}', ${idx}, this.value)"></div>`;
        }
        return `<div class="cell tap-lamp" data-type="${type}" data-idx="${idx}"><div ${colorStyle} class="label">${label}</div><div class="value">${val}</div></div>`;
    }

    function directUpdate(id, val) { store.current[id] = Number(val); sync(); }
    function directUpdateLamp(type, idx, val) { store.lamps[type][idx] = Number(val); sync(); }

    function attachEvents() {
        let timer;
        document.querySelectorAll('.cell').forEach(el => {
            el.addEventListener('touchstart', (e) => {
                if(store.inputMode === 'input') return;
                el.classList.add('tap-active');
                timer = setTimeout(() => { el.classList.add('tap-minus'); }, 600);
            });
            el.addEventListener('touchend', (e) => {
                if(store.inputMode === 'input') return;
                clearTimeout(timer);
                const isMinus = el.classList.contains('tap-minus');
                const step = Number(el.dataset.step || 1);
                const val = isMinus ? -step : step;

                if (el.classList.contains('tap-btn')) {
                    store.current[el.dataset.id] += val;
                } else if (el.classList.contains('tap-lamp')) {
                    store.lamps[el.dataset.type][el.dataset.idx] += val;
                }
                el.classList.remove('tap-active', 'tap-minus');
                sync();
            });
        });
    }

    function openModal(id) { document.getElementById(id).style.display = 'block'; if(id==='predict-modal') calc(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function getP(n, d) { return (n===0 || d===0) ? "0/0" : "1/" + (d/n).toFixed(1); }

    function calc() {
        const c = store.current;
        const g = c.g;
        const b = c.b;
        const r = c.r;

        // ãƒãƒ¼ã®è¨ˆç®— (ç°¡æ˜“ãƒ™ã‚¤ã‚º)
        let likeli = [1,1,1,1,1,1];
        const p = PARAMS.king;
        for(let i=0; i<6; i++) {
            if(g>0) {
                likeli[i] *= Math.pow(1/p.b[i], b) * Math.pow(1-1/p.b[i], g-b);
                likeli[i] *= Math.pow(1/p.r[i], r) * Math.pow(1-1/p.r[i], g-r);
                likeli[i] *= Math.pow(1/p.bell[i], c.bell) * Math.pow(1-1/p.bell[i], g-c.bell);
            }
        }
        let sum = likeli.reduce((a,b)=>a+b, 0);
        let probs = likeli.map(v => (v/sum)*100);
        let max = Math.max(...probs);

        document.getElementById('predict-bars-ui').innerHTML = probs.map((v, i) => `
            <div class="bar-container">
                <div class="bar-label">è¨­å®š${i+1}</div>
                <div class="bar-bg"><div class="bar-fill" style="width:${(v/max)*100}%"></div></div>
                <div class="bar-pct">${v.toFixed(1)}%</div>
            </div>
        `).join('');

        document.getElementById('detail-rows').innerHTML = [
            ["ç·ã‚²ãƒ¼ãƒ æ•°", (store.start.g + g), "-"],
            ["BIG", (store.start.b + b), getP(store.start.b + b, store.start.g + g)],
            ["REG", (store.start.r + r), getP(store.start.r + r, store.start.g + g)],
            ["ãƒœãƒ¼ãƒŠã‚¹åˆç®—", (store.start.b+b+store.start.r+r), getP(store.start.b+b+store.start.r+r, store.start.g+g)],
            ["é€šå¸¸ãƒ™ãƒ«", c.bell, getP(c.bell, g)],
            ["BIGä¸­ã‚¹ã‚¤ã‚«", c.suika, getP(c.suika, b*24)],
            ["BIGç´”ãƒã‚ºãƒ¬", c.hazure, getP(c.hazure, b*24)]
        ].map(row => `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td></tr>`).join('');

        const l = store.lamps;
        document.getElementById('lamp-rows').innerHTML = [
            ["BIGç­ä½“", ...l.big], ["REGã‚µã‚¤ãƒ‰", ...l.regS], ["REGç­ä½“", ...l.regT]
        ].map(row => `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td><td>${row[5]}</td></tr>`).join('');
    }

    function resetAll() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    // åˆæœŸåŒ–
    document.getElementById('s-g').value = store.start.g;
    document.getElementById('s-b').value = store.start.b;
    document.getElementById('s-r').value = store.start.r;
    document.getElementById('machine-select').value = store.machine;
    updateMachine();
    buildUI();
</script>
</body>
</html>
