<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HANA Counter V6</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --cell-bg: #444444;
            --grid-line: #111111;
            --text-white: #ffffff;
            --lamp-blue: #33aaff;
            --lamp-yellow: #ffdd44;
            --lamp-green: #44ff44;
            --lamp-red: #ff4444;
        }

        html, body {
            background: var(--bg-color); color: var(--text-white);
            font-family: sans-serif; margin: 0; padding: 0;
            user-select: none; -webkit-user-select: none;
            touch-action: pan-y; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è¨±å¯ */
        }

        /* --- è™¹è‰²ãƒ†ã‚­ã‚¹ãƒˆã®å®šç¾© --- */
        .rainbow {
            display: inline-block;
            font-weight: bold;
            background: linear-gradient(to right, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 200% auto;
            -webkit-background-clip: text; /* Safari/Chromeç”¨ */
            background-clip: text;
            -webkit-text-fill-color: transparent; /* Safari/Chromeç”¨æ–‡å­—è‰²é€é */
            color: transparent; 
            animation: rainbow_anim 3s linear infinite;
        }
        @keyframes rainbow_anim { to { background-position: 200% center; } }

        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 15px; background: #000; position: sticky; top: 0; z-index: 100;
        }
        .header-icon { font-size: 20px; cursor: pointer; color: white; padding: 5px; }
        .header-title { font-size: 15px; font-weight: bold; border-bottom: 2px solid white; }

        .container { padding: 4px 10px 80px; }
        .section-title { text-align: center; margin: 6px 0 2px; font-size: 11px; color: white; font-weight: bold; }

        .grid { display: grid; gap: 1px; background: var(--grid-line); border: 1px solid var(--grid-line); margin-bottom: 5px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        
        .cell {
            background: var(--cell-bg); padding: 5px 2px; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 38px;
        }
        .label { font-size: 10px; color: white; margin-bottom: 0px; pointer-events: none; }
        .value { font-size: 20px; font-weight: bold; line-height: 1.2; color: white; pointer-events: none; }

        .touch-active { background: #666 !important; }
        .minus-mode { background: #900 !important; }

        .val-input {
            width: 100%; background: transparent; color: white; border: none;
            text-align: center; font-size: 20px; font-weight: bold; outline: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 200; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #000; }
        .modal-body { padding: 5px 15px 40px; max-width: 600px; margin: 0 auto; }

        /* è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–‡å­—ã¨ã‚³ãƒ­ãƒ³ã‚’ç¢ºå®Ÿã«ç™½ãï¼‰ */
        .detail-table { width: 100%; border-collapse: collapse; font-size: 13px; color: white; }
        .detail-table th { background: #222; text-align: left; padding: 7px; border-bottom: 1px solid #444; font-weight: normal; }
        .detail-table td { padding: 7px; border-bottom: 1px solid #444; text-align: right; font-weight: bold; color: #fff !important; }
        .lamp-detail { font-size: 11px; }
        .white-symbol { color: #ffffff !important; font-weight: bold; margin: 0 2px; }

        /* æ¨æ¸¬ãƒãƒ¼ */
        .bar-row { display: flex; align-items: center; margin: 6px 0; font-size: 13px; color: white; }
        .bar-bg { flex: 1; height: 8px; background: #333; margin: 0 10px; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.4s; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-icon" onclick="openModal('predict-modal')">ğŸ”</div>
    <div class="header-title" id="disp-machine">---</div>
    <div class="header-icon" onclick="openModal('setting-modal')">âš™ï¸</div>
</div>

<div class="container" id="main-ui">
    <p style="text-align:center; padding-top:40px;">Loading...</p>
</div>

<div id="setting-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div><div style="font-weight:bold; color:white;">è¨­å®š</div>
        <div class="header-icon" onclick="closeModal('setting-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title">ï¼œæ©Ÿç¨®é¸æŠï¼</p>
        <select id="machine-select" style="width:100%; padding:10px; background:#333; color:white;" onchange="updateMachine()">
            <option value="king">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
            <option value="new">ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
        </select>
        <p class="section-title">ï¼œå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼</p>
        <button id="mode-toggle" style="width:100%; padding:10px; background:#333; color:white; border:1px solid #555;" onclick="toggleMode()">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å…¥åŠ›</button>
        <p class="section-title">ï¼œæ‰“ã¡å§‹ã‚ãƒ‡ãƒ¼ã‚¿ï¼</p>
        <div class="grid grid-3">
            <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><input type="number" class="val-input" id="start-g" onchange="saveStart()"></div>
            <div class="cell"><div class="label">BIG</div><input type="number" class="val-input" id="start-b" onchange="saveStart()"></div>
            <div class="cell"><div class="label">REG</div><input type="number" class="val-input" id="start-r" onchange="saveStart()"></div>
        </div>
        <button onclick="closeModal('setting-modal')" style="width:100%; padding:15px; background:#000; color:#0f0; border:1px solid #0f0; margin-top:10px;">æ±ºå®š</button>
        <button onclick="resetAll()" style="width:100%; padding:10px; background:transparent; color:#f44; border:1px solid #f44; margin-top:20px;">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<div id="predict-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div><div style="font-weight:bold; color:white;">æ¨æ¸¬çµæœ</div>
        <div class="header-icon" onclick="closeModal('predict-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title">ï¼œè¨­å®šæœŸå¾…åº¦ï¼</p>
        <div id="predict-bars"></div>
        <p class="section-title" style="margin-top:15px;">ï¼œè©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼</p>
        <table class="detail-table" id="detail-rows"></table>
    </div>
</div>

<script>
    const INITIAL_DATA = {
        machine: 'king', mode: 'tap',
        start: { g:0, b:0, r:0 },
        cur: { g:0, b:0, r:0, bell:0, suika:0, hazure:0, retro_d:0, retro:0 },
        lamps: { big: [0,0,0,0,0], regS: [0,0,0,0,0], regT: [0,0,0,0,0] }
    };

    let data;
    try {
        const saved = localStorage.getItem('hana_v6_data');
        data = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(INITIAL_DATA));
        if(!data.lamps) data.lamps = INITIAL_DATA.lamps; // ç ´æå¯¾ç­–
    } catch (e) {
        data = JSON.parse(JSON.stringify(INITIAL_DATA));
    }

    const PARAMS = {
        king: { b:[292,282,273,264,252,234], r:[489,455,422,399,368,336], bell:[7.2,7.15,7.1,7.05,7,6.7] }
    };

    function init() {
        document.getElementById('machine-select').value = data.machine;
        document.getElementById('start-g').value = data.start.g;
        document.getElementById('start-b').value = data.start.b;
        document.getElementById('start-r').value = data.start.r;
        updateView();
    }

    function save() {
        localStorage.setItem('hana_v6_data', JSON.stringify(data));
        updateView();
    }

    function saveStart() {
        data.start.g = Number(document.getElementById('start-g').value) || 0;
        data.start.b = Number(document.getElementById('start-b').value) || 0;
        data.start.r = Number(document.getElementById('start-r').value) || 0;
        save();
    }

    function updateMachine() { data.machine = document.getElementById('machine-select').value; save(); }
    function toggleMode() { data.mode = (data.mode === 'tap' ? 'input' : 'tap'); save(); }

    function updateView() {
        document.getElementById('disp-machine').innerText = (data.machine === 'king' ? 'ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ' : 'ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ');
        document.getElementById('mode-toggle').innerText = (data.mode === 'tap' ? 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å…¥åŠ›' : 'æ•°å€¤å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰');
        renderMain();
    }

    function renderMain() {
        const c = data.cur; const s = data.start;
        const html = `
            <p class="section-title">ï¼œæ‰“ã¡å§‹ã‚ï¼</p>
            <div class="grid grid-3">
                <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><div class="value">${s.g}</div></div>
                <div class="cell"><div class="label">BIG</div><div class="value">${s.b}</div></div>
                <div class="cell"><div class="label">REG</div><div class="value">${s.r}</div></div>
            </div>
            <p class="section-title">ï¼œç¾åœ¨ï¼</p>
            <div class="grid grid-3">${mkCell('g','ã‚²ãƒ¼ãƒ æ•°',c.g,50)}${mkCell('b','BIG',c.b)}${mkCell('r','REG',c.r)}</div>
            <p class="section-title">ï¼œé€šå¸¸ãƒ™ãƒ« / BIGä¸­ã‚¹ã‚¤ã‚«ï¼</p>
            <div class="grid grid-2">${mkCell('bell','ãƒ™ãƒ«',c.bell)}${mkCell('suika','ã‚¹ã‚¤ã‚«',c.suika)}</div>
            <p class="section-title">ï¼œBIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkLamp('big')}</div>
            <p class="section-title">ï¼œREGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkLamp('regS')}</div>
            <p class="section-title">ï¼œREGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkLamp('regT')}</div>
            <p class="section-title">ï¼œãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰ï¼</p>
            <div class="grid grid-2">${mkCell('retro_d','æ¡ä»¶é”æˆ',c.retro_d)}${mkCell('retro','ç™ºç”Ÿ',c.retro)}</div>
            <p class="section-title">ï¼œBIGï¼šç´”ãƒã‚ºãƒ¬ï¼</p><div class="grid">${mkCell('hazure','',c.hazure)}</div>
        `;
        document.getElementById('main-ui').innerHTML = html;
        if(data.mode === 'tap') attachEvents();
    }

    function mkCell(id, label, val, step=1) {
        if(data.mode === 'input') return `<div class="cell"><div class="label">${label}</div><input type="number" class="val-input" value="${val}" onchange="data.cur.${id}=Number(this.value);save();"></div>`;
        return `<div class="cell t-btn" data-id="${id}" data-step="${step}"><div class="label">${label}</div><div class="value">${val}</div></div>`;
    }

    function mkLamp(type) {
        const names = ['é’','é»„','ç·‘','èµ¤','è™¹'];
        const colors = ['var(--lamp-blue)','var(--lamp-yellow)','var(--lamp-green)','var(--lamp-red)','rainbow'];
        return names.map((name, i) => {
            const val = data.lamps[type][i];
            const clsAttr = colors[i] === 'rainbow' ? 'class="rainbow"' : `style="color:${colors[i]}"`;
            if(data.mode === 'input') return `<div class="cell"><div class="label" ${clsAttr}>${name}</div><input type="number" class="val-input" value="${val}" onchange="data.lamps.${type}[${i}]=Number(this.value);save();"></div>`;
            return `<div class="cell t-lamp" data-type="${type}" data-idx="${i}"><div class="label" ${clsAttr}>${name}</div><div class="value">${val}</div></div>`;
        }).join('');
    }

    function attachEvents() {
        document.querySelectorAll('.cell').forEach(el => {
            if(!el.classList.contains('t-btn') && !el.classList.contains('t-lamp')) return;
            let sy, sx, isCancel, timer;
            el.ontouchstart = (e) => {
                sy = e.touches[0].clientY; sx = e.touches[0].clientX; isCancel = false;
                el.classList.add('touch-active');
                timer = setTimeout(() => { if(!isCancel) el.classList.add('minus-mode'); }, 600);
            };
            el.ontouchmove = (e) => {
                if(Math.abs(e.touches[0].clientY - sy) > 6 || Math.abs(e.touches[0].clientX - sx) > 6) {
                    isCancel = true; el.classList.remove('touch-active','minus-mode'); clearTimeout(timer);
                }
            };
            el.ontouchend = () => {
                clearTimeout(timer);
                if(isCancel) return;
                const step = Number(el.dataset.step || 1) * (el.classList.contains('minus-mode') ? -1 : 1);
                if(el.dataset.id) data.cur[el.dataset.id] = Math.max(0, data.cur[el.dataset.id] + step);
                else data.lamps[el.dataset.type][el.dataset.idx] = Math.max(0, data.lamps[el.dataset.type][el.dataset.idx] + step);
                el.classList.remove('touch-active','minus-mode');
                save();
            };
        });
    }

    function openModal(id) { document.getElementById(id).style.display = 'block'; if(id==='predict-modal') calc(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function resetAll() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) { localStorage.removeItem('hana_v6_data'); location.reload(); } }

    function getP(n, d) { return (n<=0 || d<=0) ? "---" : `1/${(d/n).toFixed(1)}`; }

    function calc() {
        const c = data.cur; const s = data.start;
        const tg = s.g + c.g; const tb = s.b + c.b; const tr = s.r + c.r;
        
        // æ¨æ¸¬è¨ˆç®—
        let likeli = [1,1,1,1,1,1]; const p = PARAMS[data.machine];
        if(c.g > 10) {
            for(let i=0; i<6; i++) {
                likeli[i] *= Math.pow(1/p.b[i], c.b) * Math.pow(1-1/p.b[i], Math.max(0, c.g-c.b));
                likeli[i] *= Math.pow(1/p.r[i], c.r) * Math.pow(1-1/p.r[i], Math.max(0, c.g-c.r));
                likeli[i] *= Math.pow(1/p.bell[i], c.bell) * Math.pow(1-1/p.bell[i], Math.max(0, c.g-c.bell));
            }
        }
        const sum = likeli.reduce((a,b)=>a+b,0) || 1;
        const probs = likeli.map(v=>(v/sum)*100);
        const max = Math.max(...probs) || 1;

        document.getElementById('predict-bars').innerHTML = probs.map((v,i)=>`
            <div class="bar-row"><div>è¨­å®š${i+1}</div><div class="bar-bg"><div class="bar-fill" style="width:${(v/max)*100}%"></div></div><div style="width:40px; text-align:right;">${v.toFixed(1)}%</div></div>
        `).join('');

        const mkLD = (arr) => {
            const names = ['é’','é»„','ç·‘','èµ¤','è™¹'];
            const cols = ['var(--lamp-blue)','var(--lamp-yellow)','var(--lamp-green)','var(--lamp-red)','rainbow'];
            return arr.map((v, i) => `<span class="${cols[i]==='rainbow'?'rainbow':''}" style="${cols[i]!=='rainbow'?'color:'+cols[i]:''}">${names[i]}</span><span class="white-symbol">:</span>${v}`).join(' ');
        };

        document.getElementById('detail-rows').innerHTML = `
            <tr><th>ç·ã‚²ãƒ¼ãƒ æ•°</th><td>${tg}G</td></tr>
            <tr><th>BIG / REG</th><td>${tb} / ${tr}</td></tr>
            <tr><th>ãƒœãƒ¼ãƒŠã‚¹åˆç®—</th><td>${tb+tr} <span class="white-symbol">(${getP(tb+tr, tg)})</span></td></tr>
            <tr><th>é€šå¸¸ãƒ™ãƒ«</th><td>${c.bell} <span class="white-symbol">(${getP(c.bell, c.g)})</span></td></tr>
            <tr><th>BIGä¸­ã‚¹ã‚¤ã‚«</th><td>${c.suika} <span class="white-symbol">(${getP(c.suika, c.b*24)})</span></td></tr>
            <tr><th>BIGç­ä½“ãƒ©ãƒ³ãƒ—</th><td class="lamp-detail">${mkLD(data.lamps.big)}</td></tr>
            <tr><th>REGã‚µã‚¤ãƒ‰</th><td class="lamp-detail">${mkLD(data.lamps.regS)}</td></tr>
            <tr><th>REGç­ä½“ãƒ©ãƒ³ãƒ—</th><td class="lamp-detail">${mkLD(data.lamps.regT)}</td></tr>
            <tr><th>ãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰</th><td>${c.retro} / ${c.retro_d}</td></tr>
            <tr><th>BIGç´”ãƒã‚ºãƒ¬</th><td>${c.hazure}</td></tr>
        `;
    }

    window.onload = init;
</script>
</body>
</html>
