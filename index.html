<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HANA Counter V7</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --cell-bg: #444444;
            --grid-line: #111111;
            --text-white: #ffffff;
            --lamp-blue: #33aaff;
            --lamp-yellow: #ffdd44;
            --lamp-green: #44ff44;
            --lamp-red: #ff4444;
            --lamp-white: #dddddd;
        }

        html, body {
            background: var(--bg-color); color: var(--text-white);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0; height: 100%;
            user-select: none; -webkit-user-select: none;
            touch-action: pan-y;
        }

        /* è™¹è‰²ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .rainbow {
            background: linear-gradient(to right, #ff3333, #ffff33, #33ff33, #33ffff, #3333ff, #ff33ff, #ff3333);
            background-size: 200% auto;
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; color: transparent;
            font-weight: bold; animation: rainbow_move 3s linear infinite;
        }
        @keyframes rainbow_move { to { background-position: 200% center; } }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®š */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 15px; background: #000; position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid #333;
        }
        .header-icon { font-size: 22px; cursor: pointer; color: white; padding: 5px; }
        .header-title { font-size: 15px; font-weight: bold; border-bottom: 2px solid white; }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .container { padding: 5px 10px 80px; }
        .main-grid-wrapper { display: flex; flex-direction: column; }
        
        /* æ¨ªç”»é¢å¯¾å¿œï¼š2åˆ—ã‚°ãƒªãƒƒãƒ‰ */
        @media (orientation: landscape) {
            .main-grid-wrapper {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                align-items: start;
            }
        }

        .section-title { text-align: center; margin: 6px 0 2px; font-size: 11px; color: white; font-weight: bold; }

        .grid { display: grid; gap: 1px; background: var(--grid-line); border: 1px solid var(--grid-line); margin-bottom: 5px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        
        .cell {
            background: var(--cell-bg); padding: 5px 2px; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 40px;
        }
        .label { font-size: 10px; color: white; margin-bottom: 1px; pointer-events: none; }
        .value { font-size: 20px; font-weight: bold; line-height: 1.2; color: white; pointer-events: none; }

        .touch-active { background: #666 !important; }
        .minus-mode { background: #900 !important; }
        .selected-lamp { border: 2px solid #fff; background: #666; }

        .val-input {
            width: 100%; background: transparent; color: white; border: none;
            text-align: center; font-size: 20px; font-weight: bold; outline: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œï¼‰ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            flex-direction: column;
        }
        .modal.active { display: flex; }
        .modal-header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #000; border-bottom: 1px solid #333; }
        .modal-body { flex: 1 1 auto; overflow-y: auto; padding: 10px 15px 40px; -webkit-overflow-scrolling: touch; }

        /* ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›ãƒœã‚¿ãƒ³ */
        .export-btn { width: 100%; padding: 15px; background: #000; color: #0ff; border: 1px solid #0ff; margin-top: 10px; font-weight: bold; }
        
        /* è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« */
        .detail-table { width: 100%; border-collapse: collapse; font-size: 12px; color: white; margin-bottom: 20px; }
        .detail-table th { background: #222; text-align: left; padding: 10px 5px; border-bottom: 1px solid #444; font-weight: normal; }
        .detail-table td { padding: 10px 5px; border-bottom: 1px solid #444; text-align: right; font-weight: bold; color: white; cursor: pointer; }
        .detail-row:active { background: #333; }
        
        /* æŠ˜ã‚ŠãŸãŸã¿ã‚°ãƒ©ãƒ• */
        .sub-graph-row { display: none; background: #111; }
        .sub-graph-row.open { display: table-row; }
        .sub-graph-container { padding: 10px; }
        
        .lamp-detail span { margin-left: 3px; font-size: 10px; }
        .white-txt { color: #fff !important; }

        /* æ¨æ¸¬ãƒãƒ¼ */
        .bar-row { display: flex; align-items: center; margin: 6px 0; font-size: 12px; color: white; }
        .bar-bg { flex: 1; height: 8px; background: #333; margin: 0 8px; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.3s; }
        
        /* æœŸå¾…å€¤è¡¨ç¤º */
        .expect-box { background: #222; padding: 10px; border: 1px solid #444; margin-bottom: 15px; }
        .expect-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .expect-val { font-weight: bold; color: #0f0; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-icon" onclick="openModal('predict-modal')">ğŸ”</div>
    <div class="header-title" id="disp-machine">---</div>
    <div class="header-icon" onclick="openModal('setting-modal')">âš™ï¸</div>
</div>

<div class="container">
    <div class="main-grid-wrapper" id="main-ui">
        </div>
</div>

<div id="setting-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div><div style="font-weight:bold; color:white;">è¨­å®š</div>
        <div class="header-icon" onclick="closeModal('setting-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title">ï¼œæ©Ÿç¨®é¸æŠï¼</p>
        <select id="machine-select" style="width:100%; padding:10px; background:#333; color:white; border:1px solid #555;" onchange="updateMachine()">
            <option value="king">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
            <option value="new">ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
        </select>
        
        <p class="section-title">ï¼œå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼</p>
        <button id="mode-toggle" style="width:100%; padding:10px; background:#333; color:white; border:1px solid #555;" onclick="toggleMode()">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å…¥åŠ›</button>
        
        <p class="section-title">ï¼œæ‰“ã¡å§‹ã‚ãƒ‡ãƒ¼ã‚¿ï¼</p>
        <div class="grid grid-3">
            <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><input type="number" class="val-input" id="start-g" onchange="saveStart()"></div>
            <div class="cell"><div class="label">BIG</div><input type="number" class="val-input" id="start-b" onchange="saveStart()"></div>
            <div class="cell"><div class="label">REG</div><input type="number" class="val-input" id="start-r" onchange="saveStart()"></div>
        </div>

        <p class="section-title">ï¼œBIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—(æœä¸€)ï¼</p>
        <div class="grid grid-5" id="morning-lamp-selector">
            </div>

        <button onclick="exportData()" class="export-btn">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›(ã‚³ãƒ”ãƒ¼)</button>
        <button onclick="resetAll()" style="width:100%; padding:10px; background:transparent; color:#f44; border:1px solid #f44; margin-top:20px;">å…¨ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<div id="predict-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div><div style="font-weight:bold; color:white;">è¨­å®šæ¨æ¸¬</div>
        <div class="header-icon" onclick="closeModal('predict-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title">ï¼œè¨­å®šæœŸå¾…åº¦ï¼</p>
        <div id="predict-bars" style="margin-bottom:15px;"></div>

        <p class="section-title">ï¼œæœŸå¾…å€¤ï¼</p>
        <div class="expect-box" id="expect-info"></div>

        <p class="section-title">ï¼œè©³ç´°ãƒ‡ãƒ¼ã‚¿ (ã‚¿ãƒƒãƒ—ã§è©³ç´°æ¨æ¸¬)ï¼</p>
        <table class="detail-table" id="detail-rows"></table>
    </div>
</div>

<script>
    // --- å®šæ•°ãƒ»è¨­å®š ---
    const DEFAULTS = {
        machine: 'king', mode: 'tap',
        start: { g:0, b:0, r:0 },
        cur: { g:0, b:0, r:0, bell:0, suika:0, retro_d:0, retro:0 },
        lamps: { big: [0,0,0,0,0], regS: [0,0,0,0,0], regT: [0,0,0,0,0] },
        morning: -1 // 0:ç™½, 1:é’, 2:é»„, 3:ç·‘, 4:èµ¤, -1:æœªå…¥åŠ›
    };

    // æ©Ÿæ¢°å‰²
    const PAYOUT = [97, 99, 101, 104, 107, 110];

    // è§£æå€¤ãƒ‡ãƒ¼ã‚¿
    const PARAMS = {
        king: {
            b: [292, 280, 268, 257, 244, 232],
            r: [489, 452, 420, 390, 360, 332],
            bell: [7.254, 7.250, 7.249, 7.048, 6.975, 6.940],
            suika: [42.01, 38.55, 36.21, 31.51, 29.39, 27.54],
            // é’, é»„, ç·‘, èµ¤, è™¹
            lampB: [
                [32.77, 35.42, 40.96, 84.02, 6553.6], // è¨­å®š1
                [29.13, 31.21, 38.55, 78.96, 3276.8], // è¨­å®š2
                [26.21, 27.89, 35.42, 63.63, 1638.4], // è¨­å®š3
                [23.83, 25.21, 34.49, 55.54, 655.36], // è¨­å®š4
                [21.85, 23.41, 30.48, 44.28, 327.68], // è¨­å®š5
                [20.16, 21.85, 29.13, 37.88, 131.07]  // è¨­å®š6
            ],
            // é’, é»„, ç·‘, èµ¤, è™¹ (ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—)
            sideR: [
                [36, 24, 24, 16, 0.02], // 1 (å¤§ã¾ã‹ãªæ¯”ç‡)
                [23, 35, 17, 25, 0.05], // 2
                [34, 22, 26, 18, 0.10], // 3
                [22, 32, 18, 28, 0.20], // 4
                [31, 21, 29, 19, 0.39], // 5
                [25, 25, 25, 25, 0.78]  // 6
            ],
            // ãƒ¬ãƒˆãƒ­ç™ºç”Ÿç‡(æ¡ä»¶é”æˆæ™‚) â€»ä¸æ˜ã¯é™¤å¤–
            retro: [0, 13.55, 11.88, 8.70, 8.60, 0] 
        }
    };
    // newKingã‚‚åŒã˜ã¨ã™ã‚‹ï¼ˆä»®ï¼‰
    PARAMS.new = PARAMS.king;

    let data = loadData();

    function loadData() {
        try {
            const saved = localStorage.getItem('hana_v7_data');
            const d = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULTS));
            if(!d.lamps) d.lamps = DEFAULTS.lamps;
            if(d.morning === undefined) d.morning = -1;
            return d;
        } catch(e) { return JSON.parse(JSON.stringify(DEFAULTS)); }
    }

    function save() { localStorage.setItem('hana_v7_data', JSON.stringify(data)); updateView(); }
    
    // --- åˆæœŸåŒ– & ãƒ“ãƒ¥ãƒ¼æ›´æ–° ---
    function init() {
        document.getElementById('machine-select').value = data.machine;
        document.getElementById('start-g').value = data.start.g;
        document.getElementById('start-b').value = data.start.b;
        document.getElementById('start-r').value = data.start.r;
        renderMorningSelector();
        updateView();
    }

    function updateView() {
        document.getElementById('disp-machine').innerText = (data.machine === 'king' ? 'ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ' : 'ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ');
        document.getElementById('mode-toggle').innerText = (data.mode === 'tap' ? 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å…¥åŠ›' : 'æ•°å€¤å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰');
        renderMain();
    }

    // æœä¸€ãƒ©ãƒ³ãƒ—ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ç”Ÿæˆ
    function renderMorningSelector() {
        const cols = ['var(--lamp-white)', 'var(--lamp-blue)','var(--lamp-yellow)','var(--lamp-green)','var(--lamp-red)'];
        const labs = ['ç™½','é’','é»„','ç·‘','èµ¤'];
        let html = '';
        for(let i=0; i<5; i++) {
            const isSel = (data.morning === i) ? 'selected-lamp' : '';
            html += `<div class="cell ${isSel}" onclick="setMorning(${i})"><div class="label" style="color:${cols[i]}; font-size:14px; font-weight:bold;">${labs[i]}</div></div>`;
        }
        document.getElementById('morning-lamp-selector').innerHTML = html;
    }
    function setMorning(val) {
        data.morning = (data.morning === val) ? -1 : val; // ãƒˆã‚°ãƒ«
        save(); renderMorningSelector();
    }
    function saveStart() {
        data.start.g = Number(document.getElementById('start-g').value) || 0;
        data.start.b = Number(document.getElementById('start-b').value) || 0;
        data.start.r = Number(document.getElementById('start-r').value) || 0;
        save();
    }

    // --- ãƒ¡ã‚¤ãƒ³ç”»é¢ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
    function renderMain() {
        const c = data.cur; const s = data.start;
        // æŒ‡å®šã•ã‚ŒãŸè¡¨ç¤ºé †åº
        // 1. æ‰“ã¡å§‹ã‚ + ç¾åœ¨ (Group 1)
        // 2. ãƒ™ãƒ« + ã‚¹ã‚¤ã‚« (Group 2)
        // 3. ãƒ¬ãƒˆãƒ­ + BIGãƒ©ãƒ³ãƒ— (Group 3)
        // 4. ã‚µã‚¤ãƒ‰ + REGãƒ©ãƒ³ãƒ— (Group 4)
        
        const html = `
            <div>
                <p class="section-title">ï¼œæ‰“ã¡å§‹ã‚ï¼</p>
                <div class="grid grid-3">
                    <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><div class="value">${s.g}</div></div>
                    <div class="cell"><div class="label">BIG</div><div class="value">${s.b}</div></div>
                    <div class="cell"><div class="label">REG</div><div class="value">${s.r}</div></div>
                </div>
                <p class="section-title">ï¼œç¾åœ¨ï¼</p>
                <div class="grid grid-3">${mkC('g','ã‚²ãƒ¼ãƒ æ•°',c.g,50)}${mkC('b','BIG',c.b)}${mkC('r','REG',c.r)}</div>
            </div>

            <div>
                <p class="section-title">ï¼œé€šå¸¸æ™‚ï¼šãƒ™ãƒ«ï¼</p><div class="grid">${mkC('bell','',c.bell)}</div>
                <p class="section-title">ï¼œBIGï¼šã‚¹ã‚¤ã‚«ï¼</p><div class="grid">${mkC('suika','',c.suika)}</div>
            </div>

            <div>
                <p class="section-title">ï¼œãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰ï¼</p>
                <div class="grid grid-2">${mkC('retro_d','æ¡ä»¶é”æˆ',c.retro_d)}${mkC('retro','ç™ºç”Ÿ',c.retro)}</div>
                <p class="section-title">ï¼œBIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkL('big', true)}</div>
            </div>

            <div>
                <p class="section-title">ï¼œREGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkL('regS', true)}</div>
                <p class="section-title">ï¼œREGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkL('regT', true)}</div>
            </div>
        `;
        document.getElementById('main-ui').innerHTML = html;
        if(data.mode === 'tap') attachEvents();
    }

    function mkC(id, label, val, step=1) {
        if(data.mode === 'input') return `<div class="cell"><div class="label">${label}</div><input type="number" class="val-input" value="${val}" onchange="data.cur.${id}=Number(this.value);save();"></div>`;
        return `<div class="cell t-btn" data-id="${id}" data-step="${step}"><div class="label">${label}</div><div class="value">${val}</div></div>`;
    }

    function mkL(type, isRainbow) {
        const labs = ['é’','é»„','ç·‘','èµ¤','è™¹'];
        const cols = ['var(--lamp-blue)','var(--lamp-yellow)','var(--lamp-green)','var(--lamp-red)','rainbow'];
        return labs.map((l, i) => {
            const val = data.lamps[type][i];
            const colorClass = cols[i] === 'rainbow' ? 'class="rainbow"' : `style="color:${cols[i]}"`;
            // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®è™¹è‰²æŒ‡å®šã«å¯¾å¿œ
            
            if(data.mode === 'input') return `<div class="cell"><div class="label" ${colorClass}>${l}</div><input type="number" class="val-input" value="${val}" onchange="data.lamps.${type}[${i}]=Number(this.value);save();"></div>`;
            return `<div class="cell t-lamp" data-type="${type}" data-idx="${i}"><div class="label" ${colorClass}>${l}</div><div class="value">${val}</div></div>`;
        }).join('');
    }

    // --- ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ ---
    function attachEvents() {
        document.querySelectorAll('.cell').forEach(el => {
            if(!el.classList.contains('t-btn') && !el.classList.contains('t-lamp')) return;
            let sy, sx, isC, timer;
            el.ontouchstart = (e) => {
                sy = e.touches[0].clientY; sx = e.touches[0].clientX; isC = false;
                el.classList.add('touch-active');
                timer = setTimeout(() => { if(!isC) el.classList.add('minus-mode'); }, 600);
            };
            el.ontouchmove = (e) => {
                if(Math.abs(e.touches[0].clientY - sy) > 8 || Math.abs(e.touches[0].clientX - sx) > 8) {
                    isC = true; el.classList.remove('touch-active','minus-mode'); clearTimeout(timer);
                }
            };
            el.ontouchend = () => {
                clearTimeout(timer);
                if(isC) return;
                const step = Number(el.dataset.step || 1) * (el.classList.contains('minus-mode') ? -1 : 1);
                if(el.dataset.id) data.cur[el.dataset.id] = Math.max(0, data.cur[el.dataset.id] + step);
                else data.lamps[el.dataset.type][el.dataset.idx] = Math.max(0, data.lamps[el.dataset.type][el.dataset.idx] + step);
                el.classList.remove('touch-active','minus-mode');
                save();
            };
        });
    }

    function updateMachine() { data.machine = document.getElementById('machine-select').value; save(); }
    function toggleMode() { data.mode = (data.mode === 'tap' ? 'input' : 'tap'); save(); }
    function resetAll() { if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã€‚")) { localStorage.removeItem('hana_v7_data'); location.reload(); } }

    function openModal(id) { 
        document.getElementById(id).classList.add('active'); 
        if(id==='predict-modal') calc(); 
    }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // --- è¨ˆç®—ãƒ»æ¨æ¸¬ãƒ­ã‚¸ãƒƒã‚¯ ---
    function getP(n, d) { return (d<=0) ? "0/0" : `1/${(d/n).toFixed(1)}`; }

    function calc() {
        const c = data.cur; const s = data.start;
        const p = PARAMS[data.machine];

        // 1. å„è¦ç´ ã®å°¤åº¦è¨ˆç®—
        let probs = []; // 0~5: è¨­å®š1~6
        let details = {}; // å„è¦ç´ ã”ã¨ã®ç¢ºç‡åˆ†å¸ƒ

        // åˆæœŸå°¤åº¦ (1.0)
        for(let i=0; i<6; i++) probs[i] = 1.0;

        // --- å€‹åˆ¥è¦ç´ è¨ˆç®—é–¢æ•° ---
        const calcFactor = (key, n, k, table, isMulti = false) => {
            let res = [];
            for(let i=0; i<6; i++) {
                let val = 1;
                if(n > 0) {
                    if(isMulti) {
                         // å¤šé …åˆ†å¸ƒ(ç°¡æ˜“:æ¯”ç‡) - ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—ãªã©
                         // table[i] ã¯é…åˆ— [probA, probB...]
                         // å®Ÿéš›ã®å‡ºç¾æ•° k ã¯é…åˆ— [countA, countB...]
                         // å°¤åº¦ âˆ Î (prob^count)
                         let p_sum = 0;
                         // ã¾ãšç¢ºç‡ã®åˆè¨ˆã‚’è¨ˆç®—(100åˆ†ç‡å¯¾å¿œ)
                         table[i].forEach(tp => p_sum += tp);
                         
                         k.forEach((cnt, idx) => {
                             if(cnt > 0) {
                                 const prob = table[i][idx] / p_sum; 
                                 val *= Math.pow(prob, cnt);
                             }
                         });
                    } else {
                        // äºŒé …åˆ†å¸ƒ
                        const prob = 1 / table[i];
                        val = Math.pow(prob, k) * Math.pow(1 - prob, n - k);
                    }
                }
                res.push(val);
            }
            return res;
        };

        // è¨ˆç®—å®Ÿè¡Œ
        // ãƒœãƒ¼ãƒŠã‚¹
        const prob_b = calcFactor('big', c.g, c.b, p.b);
        const prob_r = calcFactor('reg', c.g, c.r, p.r);
        // ãƒ™ãƒ«
        const prob_bell = calcFactor('bell', c.g, c.bell, p.bell);
        // ã‚¹ã‚¤ã‚« (åˆ†æ¯: BIG*20)
        const prob_suika = calcFactor('suika', c.b * 20, c.suika, p.suika);
        
        // BIGãƒ©ãƒ³ãƒ— (æœä¸€å«ã‚€)
        // æœä¸€ãƒ©ãƒ³ãƒ—(0:ç™½)ã¯è‰²ãªã—ã¨ã—ã¦é™¤å¤–ã€1:é’ã€œ4:èµ¤ã¯ã‚«ã‚¦ãƒ³ãƒˆã«è¶³ã™
        let bLampCounts = [...data.lamps.big];
        if(data.morning >= 1) bLampCounts[data.morning - 1]++;
        // BIGãƒ©ãƒ³ãƒ—ã¯1/xã®ç¢ºç‡è¡¨ã ãŒã€ä¾¿å®œä¸Šå‡ºç¾ç‡ã®æ¯”ç‡ã¨ã—ã¦å¤šé …åˆ†å¸ƒçš„ã«æ‰±ã†
        // å„è¨­å®šã®å„è‰²ã®å‡ºç¾ç¢ºç‡(1/x)ã‚’ãã®ã¾ã¾é‡ã¿ã¨ã—ã¦ä½¿ç”¨
        const prob_blamp = calcFactor('blamp', 0, bLampCounts, p.lampB.map(row => row.map(v => 1/v)), true);

        // ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—
        const prob_side = calcFactor('side', 0, data.lamps.regS, p.sideR, true);

        // ãƒ¬ãƒˆãƒ­
        // ãƒ¬ãƒˆãƒ­ã¯è¨­å®š1,6ãŒ0(ä¸æ˜)ã®ãŸã‚ã€2-5ã®ã¿è¨ˆç®—ã—ã€1,6ã¯å¹³å‡çš„ãªå€¤ã§åŸ‹ã‚ã‚‹ç­‰ã®å‡¦ç†ãŒå¿…è¦ã ãŒ
        // ã“ã“ã§ã¯ä»•æ§˜é€šã‚Šç¢ºç‡ãŒã‚ã‚‹è¨­å®šã®ã¿ãƒ–ãƒ¼ã‚¹ãƒˆã•ã›ã‚‹
        let prob_retro = [1,1,1,1,1,1];
        if(c.retro_d > 0) {
            for(let i=0; i<6; i++) {
                if(p.retro[i] > 0) {
                    const prob = 1/p.retro[i];
                    prob_retro[i] = Math.pow(prob, c.retro) * Math.pow(1-prob, c.retro_d - c.retro);
                }
            }
        }

        // ç·åˆå°¤åº¦
        for(let i=0; i<6; i++) {
            // è¦ç´ ãŒã‚ã‚‹å ´åˆã®ã¿ä¹—ç®—
            if(c.g > 0) probs[i] *= prob_b[i] * prob_r[i] * prob_bell[i];
            if(c.b > 0) probs[i] *= prob_suika[i] * prob_blamp[i];
            if(c.r > 0) probs[i] *= prob_side[i];
            if(c.retro_d > 0) probs[i] *= prob_retro[i];
        }
        
        // --- æœŸå¾…åº¦ã‚°ãƒ©ãƒ•ç”Ÿæˆ ---
        const drawBars = (targetId, rawProbs) => {
            const sum = rawProbs.reduce((a,b)=>a+b,0) || 1;
            const pct = rawProbs.map(v => (v/sum)*100);
            const max = Math.max(...pct) || 1;
            let html = '';
            pct.forEach((v, i) => {
                html += `<div class="bar-row"><div>è¨­å®š${i+1}</div><div class="bar-bg"><div class="bar-fill" style="width:${(v/max)*100}%"></div></div><div style="width:40px; text-align:right;">${v.toFixed(1)}%</div></div>`;
            });
            document.getElementById(targetId).innerHTML = html;
            return pct; // æœŸå¾…è¨­å®šè¨ˆç®—ç”¨ã«æˆ»ã™
        };
        const finalPcts = drawBars('predict-bars', probs);

        // --- æœŸå¾…å€¤è¨ˆç®— ---
        let expSet = 0;
        finalPcts.forEach((v, i) => expSet += (i+1) * (v/100));
        
        // æ©Ÿæ¢°å‰²ã®ç·šå½¢è£œå®Œ
        const floorS = Math.floor(expSet);
        const ceilS = Math.ceil(expSet);
        let expRate = 0;
        if(floorS < 1) expRate = PAYOUT[0];
        else if(floorS === ceilS) expRate = PAYOUT[floorS-1];
        else {
            const r1 = PAYOUT[floorS-1];
            const r2 = PAYOUT[ceilS-1];
            expRate = r1 + (r2 - r1) * (expSet - floorS);
        }

        // æœŸå¾…ç²å¾—æšæ•° = (é€šå¸¸G*3 * (æ©Ÿæ¢°å‰²% - 1))
        const totalIn = c.g * 3;
        const diffCoins = totalIn * (expRate/100 - 1);
        const diffSign = diffCoins >= 0 ? '+' : '';

        // ç·å›è»¢æ•°ï¼ˆè¨ˆç®—å¼ï¼šé€šå¸¸ + B*20 + R*10ï¼‰
        const totalG_calc = c.g + (c.b * 20) + (c.r * 10);

        document.getElementById('expect-info').innerHTML = `
            <div class="expect-row"><div>ç·å›è»¢æ•°</div><div class="expect-val" style="color:white;">${totalG_calc} G</div></div>
            <div class="expect-row"><div>æœŸå¾…è¨­å®š</div><div class="expect-val">${expSet.toFixed(2)}</div></div>
            <div class="expect-row"><div>æœŸå¾…æ©Ÿæ¢°å‰²</div><div class="expect-val">${expRate.toFixed(2)} %</div></div>
            <div class="expect-row"><div>æœŸå¾…ç²å¾—æšæ•°</div><div class="expect-val">${diffSign}${Math.round(diffCoins)} æš</div></div>
        `;

        // --- è©³ç´°ãƒ‡ãƒ¼ã‚¿ & ã‚¿ãƒƒãƒ—å±•é–‹ ---
        // ãƒ‡ãƒ¼ã‚¿æº–å‚™
        // æœä¸€ãƒ©ãƒ³ãƒ—ã‚’å«ã‚€
        const bLampTxt = mkLmpTxt(bLampCounts);
        const rSideTxt = mkLmpTxt(data.lamps.regS);
        const rTplTxt = mkLmpTxt(data.lamps.regT);

        const rows = [
            { id:'d_g', label:'é€šå¸¸æ™‚å›è»¢æ•°', val:`${c.g}å›è»¢`, prob:null },
            { id:'d_b', label:'BIG', val:`${c.b}å› <span class="white-txt">(${getP(c.b, c.g)})</span>`, prob: prob_b },
            { id:'d_r', label:'REG', val:`${c.r}å› <span class="white-txt">(${getP(c.r, c.g)})</span>`, prob: prob_r },
            { id:'d_sum', label:'åˆç®—', val:`${c.b+c.r}å› <span class="white-txt">(${getP(c.b+c.r, c.g)})</span>`, prob: null },
            { id:'d_bell', label:'é€šå¸¸æ™‚ï¼šãƒ™ãƒ«', val:`${c.bell}å› <span class="white-txt">(${getP(c.bell, c.g)})</span>`, prob: prob_bell },
            { id:'d_suika', label:'BIGï¼šã‚¹ã‚¤ã‚«', val:`${c.suika}å› <span class="white-txt">(${getP(c.suika, c.b*20)})</span>`, prob: prob_suika },
            { id:'d_blamp', label:'BIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—', val: bLampTxt, prob: prob_blamp, isL:true },
            { id:'d_side', label:'REGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—', val: rSideTxt, prob: prob_side, isL:true },
            { id:'d_rtpl', label:'REGï¼šç­ä½“ãƒ©ãƒ³ãƒ—', val: rTplTxt, prob: null }, // REGãƒ©ãƒ³ãƒ—ã¯ç¢ºå®šç³»ãªã®ã§ç¢ºç‡ã‚°ãƒ©ãƒ•åŒ–ã—ãªã„
            { id:'d_retro', label:'ãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰', val:`${c.retro}å› <span class="white-txt">(${c.retro}/${c.retro_d})</span>`, prob: prob_retro }
        ];

        let tblHtml = '';
        rows.forEach(r => {
            tblHtml += `<tr class="detail-row" onclick="toggleGraph('${r.id}')"><th>${r.label}</th><td>${r.val}</td></tr>`;
            if(r.prob) {
                tblHtml += `<tr id="graph-${r.id}" class="sub-graph-row"><td colspan="2"><div id="bar-${r.id}" class="sub-graph-container"></div></td></tr>`;
            }
        });
        document.getElementById('detail-rows').innerHTML = tblHtml;

        // ã‚°ãƒ©ãƒ•æç”»é–¢æ•°ã‚’è¦ç´ ã«ç´ä»˜ã‘ï¼ˆå³æ™‚å®Ÿè¡Œã§ã¯ãªãé–‹ã„ãŸæ™‚ã€ã ãŒãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒï¼‰
        window.tempProbs = {};
        rows.forEach(r => { if(r.prob) window.tempProbs[r.id] = r.prob; });
    }

    function mkLmpTxt(arr) {
        const n = ['é’','é»„','ç·‘','èµ¤','è™¹'];
        const c = ['var(--lamp-blue)','var(--lamp-yellow)','var(--lamp-green)','var(--lamp-red)','rainbow'];
        return arr.map((v,i)=>`<span class="${c[i]==='rainbow'?'rainbow':''}" style="${c[i]!=='rainbow'?'color:'+c[i]:''}">${n[i]}</span><span class="white-txt">:${v}</span>`).join(' ');
    }

    // æŠ˜ã‚ŠãŸãŸã¿ã‚°ãƒ©ãƒ•è¡¨ç¤º
    window.toggleGraph = function(id) {
        const row = document.getElementById(`graph-${id}`);
        if(!row) return;
        if(row.classList.contains('open')) {
            row.classList.remove('open');
        } else {
            // å…¨ã¦ã®ä»–ã®ã‚°ãƒ©ãƒ•ã‚’é–‰ã˜ã‚‹
            document.querySelectorAll('.sub-graph-row').forEach(el => el.classList.remove('open'));
            row.classList.add('open');
            // æç”»
            const probs = window.tempProbs[id];
            const sum = probs.reduce((a,b)=>a+b,0) || 1;
            const pct = probs.map(v=>(v/sum)*100);
            const max = Math.max(...pct) || 1;
            let h = `<div style="font-size:11px; color:#aaa; margin-bottom:5px;">â–¼ ã“ã®è¦ç´ ã®ã¿ã®æ¨æ¸¬</div>`;
            pct.forEach((v, i) => {
                h += `<div class="bar-row"><div>è¨­${i+1}</div><div class="bar-bg"><div class="bar-fill" style="width:${(v/max)*100}%"></div></div><div style="width:30px; text-align:right;">${Math.round(v)}%</div></div>`;
            });
            document.getElementById(`bar-${id}`).innerHTML = h;
        }
    }

    // --- ãƒ‡ãƒ¼ã‚¿å‡ºåŠ› (ã‚³ãƒ”ãƒ¼) ---
    function exportData() {
        const d = new Date();
        const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
        const s = data.start; const c = data.cur;
        const totalG = s.g + c.g; // ã“ã“ã§ã®ç·å›è»¢æ•°ã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ä¸Šã®ç·G
        const bonusG = (c.b * 20) + (c.r * 10);
        
        // æœä¸€ãƒ©ãƒ³ãƒ—ã‚’BIGãƒ©ãƒ³ãƒ—ã«ãƒãƒ¼ã‚¸
        let bLamps = [...data.lamps.big];
        if(data.morning >= 1) bLamps[data.morning - 1]++;

        const row = [
            dateStr, // æ—¥ä»˜
            totalG, // ç·å›è»¢æ•°(æ‰“ã¡å§‹ã‚+ç¾åœ¨)
            c.g,    // é€šå¸¸æ™‚å›è»¢æ•°(ç¾åœ¨)
            bonusG, // ãƒœãƒ¼ãƒŠã‚¹å›è»¢æ•°
            s.b + c.b, // BIGåˆè¨ˆ
            s.r + c.r, // REGåˆè¨ˆ
            c.bell, // ãƒ™ãƒ«
            c.suika, // ã‚¹ã‚¤ã‚«
            ...bLamps, // BIGãƒ©ãƒ³ãƒ—(é’é»„ç·‘èµ¤è™¹)
            ...data.lamps.regS, // ã‚µã‚¤ãƒ‰
            ...data.lamps.regT, // REGç­ä½“
            c.retro_d,
            c.retro
        ];
        
        const txt = row.join('\t');
        if(navigator.clipboard) {
            navigator.clipboard.writeText(txt).then(() => alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ\nã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"));
        } else {
            prompt("ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„", txt);
        }
    }

    window.onload = init;
</script>
</body>
</html>
