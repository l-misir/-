<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HANA Counter V18</title>
    <style>
        :root {
            --bg-color: #1a1a1a; --cell-bg: #444444; --grid-line: #111111;
            --text-white: #ffffff; --lamp-blue: #33aaff; --lamp-yellow: #ffdd44;
            --lamp-green: #44ff44; --lamp-red: #ff4444; --lamp-purple: #d044ff; --lamp-white: #dddddd;
            --active-btn: #007aff;
        }
        html, body {
            background: var(--bg-color); color: var(--text-white);
            font-family: -apple-system, sans-serif; margin: 0; padding: 0; height: 100%;
            user-select: none; -webkit-user-select: none; touch-action: pan-y;
        }
        .rainbow {
            background: linear-gradient(to right, #ff3333, #ffff33, #33ff33, #33ffff, #3333ff, #ff33ff, #ff3333);
            background-size: 200% auto; -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; font-weight: bold; animation: rainbow_move 3s linear infinite;
        }
        @keyframes rainbow_move { to { background-position: 200% center; } }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 4px 12px; background: #000; position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid #333; height: 40px; box-sizing: border-box;
        }
        .header-icon { font-size: 20px; cursor: pointer; color: white; padding: 5px; }
        .header-title { font-size: 14px; font-weight: bold; border-bottom: 2px solid white; }
        .container { padding: 5px 10px 80px; width: 100%; box-sizing: border-box; }

        .main-layout { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .col-left, .col-right { display: flex; flex-direction: column; width: 100%; }
        
        @media (orientation: landscape) {
            .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: start; }
        }

        .section-title { text-align: center; margin: 6px 0 2px; font-size: 11px; font-weight: bold; }
        .grid { display: grid; gap: 1px; background: var(--grid-line); border: 1px solid var(--grid-line); margin-bottom: 5px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .cell { background: var(--cell-bg); padding: 5px 2px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 40px; }
        .label { font-size: 10px; color: white; margin-bottom: 1px; pointer-events: none; }
        .value { font-size: 20px; font-weight: bold; line-height: 1.2; pointer-events: none; }
        .touch-active { background: #666 !important; }
        .minus-mode { background: #900 !important; }
        .selected-lamp { border: 2px solid #fff; background: #666; }
        .active-mode { background: var(--active-btn) !important; color: white; }
        .val-input { width: 100%; background: transparent; color: white; border: none; text-align: center; font-size: 20px; font-weight: bold; outline: none; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; }
        .modal.active { display: flex; }
        .modal-header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 4px 12px; background: #000; border-bottom: 1px solid #333; height: 40px; box-sizing: border-box; }
        .modal-body { flex: 1 1 auto; overflow-y: auto; padding: 10px 15px 40px; }

        @media (orientation: landscape) {
            .modal-body { padding: 5px 15px 20px; }
            .modal-body .section-title { margin: 4px 0 1px; font-size: 10px; }
            .modal-body .cell { min-height: 30px; padding: 2px; }
            .modal-body .value { font-size: 16px; }
            .modal-body .label { font-size: 9px; }
            .modal-body .val-input { font-size: 16px; }
            .modal-body button { padding: 8px; margin-top: 10px; font-size: 12px; }
            .detail-table th, .detail-table td { padding: 6px 4px; font-size: 11px; }
            .bar-row { margin: 2px 0; font-size: 11px; }
            .bar-bg { height: 8px; }
            .expect-box { padding: 5px; margin-bottom: 8px; }
            .expect-row { font-size: 11px; margin-bottom: 2px; }
        }

        .bar-row { display: flex; align-items: center; margin: 6px 0; font-size: 13px; color: white; }
        .bar-label { width: 40px; }
        .bar-bg { flex: 1; height: 10px; background: #333; margin: 0 8px; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.3s; }
        .bar-val { width: 45px; text-align: right; font-variant-numeric: tabular-nums; }
        .expect-box { background: #222; padding: 10px; border: 1px solid #444; margin-bottom: 15px; }
        .expect-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
        .expect-val { font-weight: bold; color: #0f0; }
        .detail-table { width: 100%; border-collapse: collapse; font-size: 12px; color: white; }
        .detail-table th { background: #222; text-align: left; padding: 10px 5px; border-bottom: 1px solid #444; font-weight: normal; }
        .detail-table td { padding: 10px 5px; border-bottom: 1px solid #444; text-align: right; font-weight: bold; cursor: pointer; }
        .sub-graph-row { display: none; background: #111; }
        .sub-graph-row.open { display: table-row; }
        .white-txt { color: #fff !important; font-weight: normal; }
        .export-btn { width: 100%; padding: 15px; background: #000; color: #0ff; border: 1px solid #0ff; margin-top: 10px; font-weight: bold; }
        
        select { color: white; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-icon" onclick="openModal('predict-modal')">ğŸ”</div>
    <div class="header-title" id="disp-machine">---</div>
    <div class="header-icon" onclick="openModal('setting-modal')">âš™ï¸</div>
</div>

<div class="container">
    <div id="main-ui"></div>
</div>

<div id="setting-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div><div style="font-weight:bold; color:white;">è¨­å®š</div>
        <div class="header-icon" onclick="closeModal('setting-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title">ï¼œæ©Ÿç¨®é¸æŠï¼</p>
        <div class="grid">
            <select class="val-input" style="background:#333; padding:5px;" id="machine-select" onchange="updateMachine()">
                <option value="king">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
                <option value="newking">ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠV</option>
            </select>
        </div>
        <p class="section-title">ï¼œè¡¨ç¤ºãƒ»å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ï¼</p>
        <div class="grid grid-2">
            <div class="cell" id="btn-view-personal" onclick="setViewMode('personal')"><div class="label">å€‹äºº</div></div>
            <div class="cell" id="btn-view-total" onclick="setViewMode('total')"><div class="label">å…¨ã¦</div></div>
        </div>
        <p class="section-title">ï¼œå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ï¼</p>
        <div class="grid grid-2">
            <div class="cell" id="btn-mode-tap" onclick="setInputMode('tap')"><div class="label">ã‚¿ãƒƒãƒ—</div></div>
            <div class="cell" id="btn-mode-input" onclick="setInputMode('input')"><div class="label">æ•°å€¤å…¥åŠ›</div></div>
        </div>
        <p class="section-title">ï¼œæ‰“ã¡å§‹ã‚ãƒ‡ãƒ¼ã‚¿ï¼</p>
        <div class="grid grid-3">
            <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><input type="number" class="val-input" id="start-g" onchange="saveStart()" onfocus="this.select()"></div>
            <div class="cell"><div class="label">BIG</div><input type="number" class="val-input" id="start-b" onchange="saveStart()" onfocus="this.select()"></div>
            <div class="cell"><div class="label">REG</div><input type="number" class="val-input" id="start-r" onchange="saveStart()" onfocus="this.select()"></div>
        </div>
        <p class="section-title">ï¼œBIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—(æœä¸€)ï¼</p>
        <div class="grid grid-5" id="morning-lamp-selector"></div>
        <button onclick="exportData()" class="export-btn">ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›(ã‚³ãƒ”ãƒ¼)</button>
        <button onclick="resetAll()" style="width:100%; padding:15px; background:transparent; color:#f44; border:1px solid #f44; margin-top:20px; font-weight:bold;">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<div id="predict-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div><div style="font-weight:bold; color:white;">æ¨æ¸¬</div>
        <div class="header-icon" onclick="closeModal('predict-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title" id="title-predict">ï¼œè¨­å®šæ¨æ¸¬ï¼</p>
        <div id="predict-bars" style="background:#222; padding:10px; border-radius:5px;"></div>
        <p class="section-title" id="title-expect">ï¼œæœŸå¾…å€¤ï¼</p>
        <div class="expect-box" id="expect-info"></div>
        <p class="section-title" id="title-detail">ï¼œè©³ç´°ãƒ‡ãƒ¼ã‚¿ï¼</p>
        <table class="detail-table" id="detail-rows"></table>
    </div>
</div>

<script>
    const DEFAULTS = {
        machine: 'king', mode: 'tap', viewMode: 'personal',
        start: { g:0, b:0, r:0 },
        // suikaR: REGã‚¹ã‚¤ã‚«(NewKingç”¨)
        cur: { g:0, b:0, r:0, bell:0, suika:0, suikaR:0, retro_d:0, retro:0 },
        // big: ç­ä½“ãƒ©ãƒ³ãƒ—, regS: ã‚µã‚¤ãƒ‰(King)orBIGå¾Œã‚µã‚¤ãƒ‰(New), regT: REGç­ä½“
        lamps: { big: [0,0,0,0,0], regS: [0,0,0,0,0], regT: [0,0,0,0,0] },
        morning: -1
    };

    // å…±é€šãƒ‡ãƒ¼ã‚¿ã¨æ©Ÿç¨®åˆ¥ãƒ‡ãƒ¼ã‚¿
    const ALL_PARAMS = {
        king: {
            settings: ['1','2','3','4','5','6'],
            payout: [97, 99, 101, 104, 107, 110],
            b: [292.6, 282.5, 273.1, 262.1, 244.5, 232.4],
            r: [489.1, 451.9, 417.4, 385.5, 352.3, 332.7],
            gassan: [183.1, 173.8, 165.1, 156.0, 144.5, 136.2],
            bell: [7.25, 7.20, 7.15, 7.10, 7.05, 7.00],
            suika: [42.0, 40.0, 38.0, 35.0, 32.0, 30.0],
            retro: [15.0, 13.7, 12.4, 11.1, 9.8, 8.5],
            // é’, é»„, ç·‘, èµ¤, è™¹
            lampB: [[0.4,0.3,0.2,0.08,0.02],[0.35,0.3,0.22,0.1,0.03],[0.3,0.28,0.25,0.12,0.05],[0.25,0.25,0.3,0.14,0.06],[0.2,0.22,0.35,0.16,0.07],[0.15,0.18,0.4,0.18,0.09]],
            sideR: [[0.6,0.3,0.08,0.015,0.005],[0.3,0.6,0.05,0.04,0.01],[0.5,0.25,0.2,0.04,0.01],[0.25,0.5,0.15,0.08,0.02],[0.4,0.2,0.3,0.07,0.03],[0.25,0.25,0.25,0.15,0.1]],
            // UIç”¨å®šç¾©
            colors: ['--lamp-blue', '--lamp-yellow', '--lamp-green', '--lamp-red', 'rainbow'],
            labels: ['é’', 'é»„', 'ç·‘', 'èµ¤', 'è™¹'],
            bigG: 20, regG: 10,
            suikaDenom: 20
        },
        newking: {
            settings: ['1','2','3','4','V'],
            payout: [97, 99, 101, 104, 108],
            b: [299, 291, 281, 268, 253],
            r: [496, 471, 442, 409, 372],
            gassan: [186, 180, 172, 162, 150],
            bell: [7.58, 7.52, 7.46, 7.37, 7.25],
            suika: [42.0, 38.5, 36.2, 31.5, 29.3],
            suikaR: [200, 180, 160, 140, 100], // æš«å®š(é«˜è¨­å®šã»ã©è‰¯ã„)
            retro: [15.00, 13.55, 11.88, 8.70, 8.60], // 1ã¨Vã¯æš«å®šorä»•æ§˜
            // é’, é»„, ç·‘, ç´«, è™¹
            lampB: [
               [0.3277, 0.3542, 0.4096, 0.0119, 0.00015], // 1 (Purple=1/84, Rain=1/6553)
               [0.2913, 0.3121, 0.3855, 0.0126, 0.0003], // 2
               [0.2621, 0.2789, 0.3542, 0.0157, 0.0006], // 3
               [0.2383, 0.2521, 0.3449, 0.0180, 0.0015], // 4
               [0.2185, 0.2341, 0.3048, 0.0225, 0.0030]  // V
            ],
            // BIGå¾ŒåŠã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ— (Kingã®REGã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—ç›¸å½“)
            sideR: [
               [0.3599, 0.2399, 0.2399, 0.1600, 0.0002],
               [0.2319, 0.3478, 0.1679, 0.2519, 0.0005],
               [0.3357, 0.2238, 0.2637, 0.1758, 0.0010],
               [0.2156, 0.3234, 0.1837, 0.2755, 0.0020],
               [0.2480, 0.2480, 0.2480, 0.2480, 0.0078] // V (æ¯”ç‡å‡ç­‰+è™¹å¼·)
            ],
            colors: ['--lamp-blue', '--lamp-yellow', '--lamp-green', '--lamp-purple', 'rainbow'],
            labels: ['é’', 'é»„', 'ç·‘', 'ç´«', 'è™¹'],
            bigG: 26, regG: 10,
            suikaDenom: 14 // BIG(å‰åŠ)åˆ†æ¯
        }
    };

    let data = loadData();

    function loadData() {
        try {
            const saved = localStorage.getItem('hana_v18_data');
            let d = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(DEFAULTS));
            if(!d.lamps) d.lamps = JSON.parse(JSON.stringify(DEFAULTS.lamps));
            if(!d.cur) d.cur = JSON.parse(JSON.stringify(DEFAULTS.cur));
            if(!d.machine) d.machine = 'king';
            if(d.cur.suikaR === undefined) d.cur.suikaR = 0;
            return d;
        } catch(e) { return JSON.parse(JSON.stringify(DEFAULTS)); }
    }

    function save() { localStorage.setItem('hana_v18_data', JSON.stringify(data)); renderMain(); }
    
    function init() {
        document.getElementById('start-g').value = data.start.g;
        document.getElementById('start-b').value = data.start.b;
        document.getElementById('start-r').value = data.start.r;
        document.getElementById('machine-select').value = data.machine || 'king';
        renderMorningSelector();
        renderMain(); 
    }

    function getP(k, n) { return (k <= 0 || n <= 0) ? "0/0" : `1/${(n/k).toFixed(1)}`; }

    function renderMorningSelector() {
        const pm = ALL_PARAMS[data.machine];
        const labs = ['ç™½', ...pm.labels.slice(0,4)]; // æœä¸€ã¯è™¹ãªã—
        const cols = ['var(--lamp-white)', ...pm.colors.slice(0,4)];
        let html = '';
        labs.forEach((l, i) => {
            const isSel = (data.morning === i) ? 'selected-lamp' : '';
            const colStyle = cols[i] === 'rainbow' ? 'class="rainbow"' : `style="color:${cols[i].startsWith('var')?cols[i]:'var('+cols[i]+')'}"`;
            html += `<div class="cell ${isSel}" onclick="setMorning(${i})"><div class="label" ${colStyle} style="font-size:14px; font-weight:bold;">${l}</div></div>`;
        });
        document.getElementById('morning-lamp-selector').innerHTML = html;
    }
    function setMorning(val) { data.morning = (data.morning === val) ? -1 : val; save(); renderMorningSelector(); }
    function setViewMode(m) { data.viewMode = m; save(); updateHeader(); }
    function setInputMode(m) { data.mode = m; save(); updateHeader(); }
    function updateMachine() { 
        data.machine = document.getElementById('machine-select').value; 
        save(); updateHeader(); renderMorningSelector();
    }
    function saveStart() {
        data.start.g = Number(document.getElementById('start-g').value) || 0;
        data.start.b = Number(document.getElementById('start-b').value) || 0;
        data.start.r = Number(document.getElementById('start-r').value) || 0;
        save();
    }

    function renderMain() {
        const c = data.cur; const s = data.start;
        const vG = c.g; const vB = c.b; const vR = c.r;
        const isNew = data.machine === 'newking';
        const pm = ALL_PARAMS[data.machine];

        // é …ç›®åã®åˆ‡ã‚Šæ›¿ãˆ
        const lblSuika = isNew ? "ãƒœãƒ¼ãƒŠã‚¹ï¼šã‚¹ã‚¤ã‚«" : "BIGï¼šã‚¹ã‚¤ã‚«";
        const lblSide = isNew ? "BIG(å¾ŒåŠ)ï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—" : "REGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—";
        const lblSuikaMain = isNew ? "BIG(å‰åŠ)" : "BIG"; // ã‚¹ã‚¤ã‚«æ¬„ã®ãƒ©ãƒ™ãƒ«
        
        let suikaHtml = '';
        if(isNew) {
            suikaHtml = `
            <p class="section-title">ï¼œ${lblSuika}ï¼</p>
            <div class="grid grid-2">
                ${mkC('suika', 'BIG(å‰åŠ)', c.suika)}
                ${mkC('suikaR', 'REG', c.suikaR)}
            </div>`;
        } else {
            suikaHtml = `
            <p class="section-title">ï¼œ${lblSuika}ï¼</p>
            <div class="grid">
                ${mkC('suika', '', c.suika)}
            </div>`;
        }

        const html = `
        <div class="main-layout">
            <div class="col-left">
                <p class="section-title">ï¼œæ‰“ã¡å§‹ã‚ï¼</p>
                <div class="grid grid-3">
                    <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><div class="value">${s.g}</div></div>
                    <div class="cell"><div class="label">BIG</div><div class="value">${s.b}</div></div>
                    <div class="cell"><div class="label">REG</div><div class="value">${s.r}</div></div>
                </div>

                <p class="section-title">ï¼œç¾åœ¨ï¼</p>
                <div class="grid grid-3">${mkC('g','Gæ•°',vG,50)}${mkC('b','BIG',vB)}${mkC('r','REG',vR)}</div>

                <p class="section-title">ï¼œé€šå¸¸æ™‚ï¼šãƒ™ãƒ«ï¼</p><div class="grid">${mkC('bell','',c.bell)}</div>
                
                ${suikaHtml}
            </div>

            <div class="col-right">
                <p class="section-title">ï¼œ${lblSide}ï¼</p><div class="grid grid-5">${mkL('regS')}</div>
                
                <p class="section-title">ï¼œBIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkL('big')}</div>
                
                <p class="section-title">ï¼œREGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkL('regT')}</div>

                <p class="section-title">ï¼œãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰ï¼</p>
                <div class="grid grid-2">${mkC('retro_d','æ¡ä»¶é”æˆ',c.retro_d)}${mkC('retro','ç™ºç”Ÿ',c.retro)}</div>
            </div>
        </div>
        `;
        document.getElementById('main-ui').innerHTML = html;
        if(data.mode === 'tap') attachEvents();
        updateHeader();
        try { setTimeout(calc, 0); } catch(e) {}
    }

    function mkC(id, label, val, step=1) {
        if(data.mode === 'input') return `<div class="cell"><div class="label">${label}</div><input type="number" class="val-input" value="${val}" onchange="data.cur.${id}=Number(this.value);save();" onfocus="this.select()"></div>`;
        return `<div class="cell t-btn" data-id="${id}" data-step="${step}"><div class="label">${label}</div><div class="value">${val}</div></div>`;
    }

    function mkL(type) {
        const pm = ALL_PARAMS[data.machine];
        return pm.labels.map((l, i) => {
            const v = data.lamps[type][i];
            const cName = pm.colors[i];
            const cls = cName === 'rainbow' ? 'class="rainbow"' : `style="color:var(${cName})"`;
            if(data.mode === 'input') return `<div class="cell"><div class="label" ${cls}>${l}</div><input type="number" class="val-input" value="${v}" onchange="data.lamps.${type}[${i}]=Number(this.value);save();" onfocus="this.select()"></div>`;
            return `<div class="cell t-lamp" data-type="${type}" data-idx="${i}"><div class="label" ${cls}>${l}</div><div class="value">${v}</div></div>`;
        }).join('');
    }

    function updateHeader() {
        const machineNames = {king: "ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ", newking: "ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠV"};
        document.getElementById('disp-machine').innerText = machineNames[data.machine] || "ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ";
        document.getElementById('btn-view-personal').className = `cell ${data.viewMode==='personal'?'active-mode':''}`;
        document.getElementById('btn-view-total').className = `cell ${data.viewMode==='total'?'active-mode':''}`;
        document.getElementById('btn-mode-tap').className = `cell ${data.mode==='tap'?'active-mode':''}`;
        document.getElementById('btn-mode-input').className = `cell ${data.mode==='input'?'active-mode':''}`;
    }

    function attachEvents() {
        document.querySelectorAll('.cell.t-btn, .cell.t-lamp').forEach(el => {
            let sy, sx, isC, timer;
            el.ontouchstart = (e) => {
                sy = e.touches[0].clientY; sx = e.touches[0].clientX; isC = false;
                el.classList.add('touch-active');
                timer = setTimeout(() => { if(!isC) el.classList.add('minus-mode'); }, 600);
            };
            el.ontouchmove = (e) => { if(Math.abs(e.touches[0].clientY - sy) > 10) { isC = true; clearTimeout(timer); el.classList.remove('touch-active', 'minus-mode'); }};
            el.ontouchend = () => {
                clearTimeout(timer);
                if(isC) return;
                const step = (el.classList.contains('minus-mode') ? -1 : 1) * Number(el.dataset.step || 1);
                if(el.dataset.id) data.cur[el.dataset.id] = Math.max(0, data.cur[el.dataset.id] + step);
                else data.lamps[el.dataset.type][el.dataset.idx] = Math.max(0, data.lamps[el.dataset.type][el.dataset.idx] + step);
                el.classList.remove('touch-active', 'minus-mode');
                save();
            };
        });
    }

    function calcLikelihood(n, k, probList) {
        if(n <= 0 || k < 0) return probList.map(()=>1);
        let likes = probList.map(p => {
            const pr = 1/p;
            return Math.exp(k * Math.log(pr) + (n - k) * Math.log(1 - pr));
        });
        const max = Math.max(...likes);
        return likes.map(v => v / (max || 1));
    }

    function calcMultiLikelihood(counts, table) {
        if(counts.reduce((a,b)=>a+b,0) === 0) return table.map(()=>1);
        let likes = table.map(row => {
            let l = 0;
            counts.forEach((c, i) => { if(c > 0) l += c * Math.log(row[i]); });
            return Math.exp(l);
        });
        const max = Math.max(...likes);
        return likes.map(v => v / max);
    }

    function renderBarGraph(likes, settings) {
        const sum = likes.reduce((a,b)=>a+b,0) || 1;
        const pcts = likes.map(v => (v/sum)*100);
        const maxPct = Math.max(...pcts) || 1;
        return pcts.map((p, i) => `
            <div class="bar-row">
                <div class="bar-label">è¨­å®š${settings[i]}</div>
                <div class="bar-bg"><div class="bar-fill" style="width:${(p/maxPct)*100}%"></div></div>
                <div class="bar-val">${p.toFixed(1)}%</div>
            </div>`).join('');
    }

    function calc() {
        const c = data.cur; const s = data.start;
        const pm = ALL_PARAMS[data.machine];
        const isNew = data.machine === 'newking';
        const sets = pm.settings;

        // ãƒ¢ãƒ¼ãƒ‰è¡¨è¨˜æ›´æ–°
        const modeStr = data.viewMode === 'total' ? '(å…¨ã¦)' : '(å€‹äºº)';
        document.getElementById('title-predict').innerText = `ï¼œè¨­å®šæ¨æ¸¬ ${modeStr}ï¼`;
        document.getElementById('title-expect').innerText = `ï¼œæœŸå¾…å€¤ ${modeStr}ï¼`;
        document.getElementById('title-detail').innerText = `ï¼œè©³ç´°ãƒ‡ãƒ¼ã‚¿ ${modeStr}ï¼`;

        // ãƒ‡ãƒ¼ã‚¿ã®è¨ˆç®—
        let calcG, calcB, calcR;
        if (data.viewMode === 'personal') {
            const diffG = Math.max(0, c.g - s.g);
            const diffB = Math.max(0, c.b - s.b);
            const diffR = Math.max(0, c.r - s.r);
            calcG = diffG;
            calcB = diffB;
            calcR = diffR;
        } else {
            calcG = c.g;
            calcB = c.b;
            calcR = c.r;
        }
        
        // å€‹äººé€šå¸¸æ™‚Gæ•°ï¼ˆãƒœãƒ¼ãƒŠã‚¹æ¶ˆåŒ–åˆ†ã‚’é™¤ãï¼‰
        const actG = Math.max(0, calcG - (calcB * pm.bigG + calcR * pm.regG));
        // æœŸå¾…å€¤ç”¨ç·å›è»¢æ•° (ç¾åœ¨G + ãƒœãƒ¼ãƒŠã‚¹æ¶ˆåŒ–G) - NewKingã¯å¼å¤‰æ›´
        let totalG_disp;
        if(isNew) {
            totalG_disp = calcG + (calcB * 26) + (calcR * 10);
        } else {
            totalG_disp = calcG + (calcB * 20) + (calcR * 10);
        }

        const lB = calcLikelihood(calcG, calcB, pm.b);
        const lR = calcLikelihood(calcG, calcR, pm.r);
        const lG = calcLikelihood(calcG, calcB + calcR, pm.gassan);
        const lBell = calcLikelihood(actG, c.bell, pm.bell);
        const lSui = calcLikelihood(calcB * pm.suikaDenom, c.suika, pm.suika);
        const lRet = (c.retro_d > 0) ? calcLikelihood(c.retro_d, c.retro, pm.retro) : sets.map(()=>1);
        
        // REGã‚¹ã‚¤ã‚« (NewKingã®ã¿)
        let lSuiR = sets.map(()=>1);
        if(isNew && c.suikaR > 0) {
            lSuiR = calcLikelihood(calcR * 10, c.suikaR, pm.suikaR);
        }

        let bigLamps = [...data.lamps.big]; if(data.morning >= 1) bigLamps[data.morning-1]++;
        const lBigL = calcMultiLikelihood(bigLamps, pm.lampB);
        const lSidL = calcMultiLikelihood(data.lamps.regS, pm.sideR);

        // REGç­ä½“ãƒ©ãƒ³ãƒ—æ¿ƒåšãƒ•ã‚£ãƒ«ã‚¿
        let lRegL = sets.map(()=>1);
        const t = data.lamps.regT;
        if(isNew) {
            // NewKing: é’(2+) é»„(3+) ç·‘(4+) ç´«(V)
            // settings: 1, 2, 3, 4, V
            if(t[4] > 0) lRegL = [0,0,0,0,1]; // è™¹(V?)
            else if(t[3] > 0) lRegL = [0,0,0,0,1]; // ç´«(V)
            else if(t[2] > 0) lRegL = [0,0,0,1,1]; // ç·‘(4+)
            else if(t[1] > 0) lRegL = [0,0,1,1,1]; // é»„(3+)
            else if(t[0] > 0) lRegL = [0,1,1,1,1]; // é’(2+)
        } else {
            // King: é’(2+) é»„(3+) ç·‘(4+) èµ¤(5+) è™¹(6)
            // settings: 1,2,3,4,5,6
            if(t[4] > 0) lRegL = [0,0,0,0,0,1];
            else if(t[3] > 0) lRegL = [0,0,0,0,1,1];
            else if(t[2] > 0) lRegL = [0,0,0,1,1,1];
            else if(t[1] > 0) lRegL = [0,0,1,1,1,1];
            else if(t[0] > 0) lRegL = [0,1,1,1,1,1];
        }

        const totalL = lB.map((v, i) => v * lR[i] * lBell[i] * lSui[i] * lSuiR[i] * lRet[i] * lBigL[i] * lSidL[i] * lRegL[i]);
        document.getElementById('predict-bars').innerHTML = renderBarGraph(totalL, sets);

        const sumL = totalL.reduce((a,b)=>a+b,0) || 1;
        const pcts = totalL.map(v => v/sumL);
        // æœŸå¾…è¨­å®š (Vã¯5ã¨ã—ã¦è¨ˆç®—)
        let expSet = 0; 
        pcts.forEach((p, i) => {
            let val = i+1; 
            expSet += p * val;
        });
        const expRate = pcts.reduce((a, b, i) => a + (b * pm.payout[i]), 0);
        const diff = (calcG * 3) * (expRate/100 - 1);

        document.getElementById('expect-info').innerHTML = `
            <div class="expect-row"><div>ç·å›è»¢æ•°</div><div class="expect-val" style="color:#fff">${totalG_disp} G</div></div>
            <div class="expect-row"><div>æœŸå¾…è¨­å®š</div><div class="expect-val">${expSet.toFixed(2)}</div></div>
            <div class="expect-row"><div>æœŸå¾…æ©Ÿæ¢°å‰²</div><div class="expect-val">${expRate.toFixed(2)}%</div></div>
            <div class="expect-row"><div>æœŸå¾…ç²å¾—æšæ•°</div><div class="expect-val">${diff >= 0 ? '+' : ''}${Math.round(diff)} æš</div></div>
        `;

        // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹ç¯‰
        let rows = [
            { id:'g', lab:'é€šå¸¸æ™‚å›è»¢æ•°', val:`${actG}å›è»¢`, l:null },
            { id:'b', lab:'BIG', val:`${calcB}å› <span class="white-txt">(${getP(calcB, calcG)})</span>`, l:lB },
            { id:'r', lab:'REG', val:`${calcR}å› <span class="white-txt">(${getP(calcR, calcG)})</span>`, l:lR },
            { id:'gas', lab:'åˆç®—', val:`${calcB+calcR}å› <span class="white-txt">(${getP(calcB+calcR, calcG)})</span>`, l:lG },
            { id:'bel', lab:'é€šå¸¸æ™‚ï¼šãƒ™ãƒ«', val:`${c.bell}å› <span class="white-txt">(${getP(c.bell, actG)})</span>`, l:lBell },
            { id:'sui', lab: isNew?'BIG(å‰åŠ)ï¼šã‚¹ã‚¤ã‚«':'BIGï¼šã‚¹ã‚¤ã‚«', val:`${c.suika}å› <span class="white-txt">(${getP(c.suika, calcB * pm.suikaDenom)})</span>`, l:lSui }
        ];
        
        if(isNew) {
            rows.push({ id:'suiR', lab:'REGï¼šã‚¹ã‚¤ã‚«', val:`${c.suikaR}å› <span class="white-txt">(${getP(c.suikaR, calcR * 10)})</span>`, l:lSuiR });
        }

        const lblSide = isNew ? "BIG(å¾ŒåŠ)ï¼šã‚µã‚¤ãƒ‰" : "REGï¼šã‚µã‚¤ãƒ‰";
        rows.push({ id:'bl', lab:'BIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—', val:mkLmpT(bigLamps, pm), l:lBigL });
        rows.push({ id:'sl', lab:lblSide, val:mkLmpT(data.lamps.regS, pm), l:lSidL });
        rows.push({ id:'rl', lab:'REGï¼šç­ä½“ãƒ©ãƒ³ãƒ—', val:mkLmpT(data.lamps.regT, pm), l:lRegL });
        rows.push({ id:'ret', lab:'ãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰', val:`${c.retro}å› <span class="white-txt">(${c.retro}/${c.retro_d})</span>`, l:lRet });

        document.getElementById('detail-rows').innerHTML = rows.map((r, i) => {
            const clickEvent = (r.id === 'g') ? '' : `onclick="toggleGraph('g-${i}')"`;
            const graphHtml = (r.id === 'g') ? '' : `
                <tr id="g-${i}" class="sub-graph-row">
                    <td colspan="2"><div style="padding:10px">${r.l ? '<p style="font-size:10px;color:#aaa">â–¼å€‹åˆ¥æ¨æ¸¬</p>'+renderBarGraph(r.l, sets) : '<p style="font-size:10px;color:#aaa">æ¨æ¸¬å¯¾è±¡å¤–</p>'}</div></td>
                </tr>`;
            return `<tr ${clickEvent}><th>${r.lab}</th><td>${r.val}</td></tr>` + graphHtml;
        }).join('');
    }

    function mkLmpT(arr, pm) {
        return arr.map((v,i) => {
            const col = pm.colors[i];
            const lab = pm.labels[i];
            const s = col==='rainbow'?'class="rainbow"':`style="color:var(${col})"`;
            return `<span ${s}>${lab}</span>:${v}`;
        }).join(' ');
    }

    function toggleGraph(id) {
        const el = document.getElementById(id);
        const isOp = el.classList.contains('open');
        document.querySelectorAll('.sub-graph-row').forEach(r => r.classList.remove('open'));
        if(!isOp) el.classList.add('open');
    }

    function exportData() {
        const d = new Date();
        const bL = [...data.lamps.big]; if(data.morning>=1) bL[data.morning-1]++;
        let calcG, calcB, calcR;
        if (data.viewMode === 'personal') {
            const diffG = Math.max(0, data.cur.g - data.start.g);
            const diffB = Math.max(0, data.cur.b - data.start.b);
            const diffR = Math.max(0, data.cur.r - data.start.r);
            calcG = diffG + (diffB * 20) + (diffR * 10); // KingåŸºæº–ã ãŒç°¡æ˜“å‡ºåŠ›
            calcB = diffB; calcR = diffR;
        } else {
            calcG = data.cur.g + (data.cur.b * 20) + (data.cur.r * 10);
            calcB = data.cur.b; calcR = data.cur.r;
        }
        const row = [`${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`, calcG, data.cur.g, (calcB*20)+(calcR*10), calcB, calcR, data.cur.bell, data.cur.suika, ...bL, ...data.lamps.regS, ...data.lamps.regT, data.cur.retro_d, data.cur.retro];
        navigator.clipboard.writeText(row.join('\t')).then(() => alert("ã‚³ãƒ”ãƒ¼å®Œäº†"));
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); if(id==='predict-modal') calc(); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function resetAll() { if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem('hana_v18_data'); location.reload(); } }

    window.onload = init;
</script>
</body>
</html>
