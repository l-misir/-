<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HANA Counter</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --accent-gray: #333333;
            --tap-zone: #505050;
            --modal-bg: rgba(0,0,0,0.9);
            /* ãƒ©ãƒ³ãƒ—è‰² */
            --lamp-blue: #0099ff;
            --lamp-yellow: #ffcc00;
            --lamp-green: #00cc00;
            --lamp-red: #ff3333;
            --lamp-rainbow: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; /* ãƒã‚¦ãƒ³ã‚¹é˜²æ­¢ */
            -webkit-user-select: none; /* é•·æŠ¼ã—é¸æŠé˜²æ­¢ */
            user-select: none;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--bg-color);
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .header-title {
            font-size: 18px;
            font-weight: bold;
            border-bottom: 2px solid white;
            padding-bottom: 2px;
        }
        .icon-btn {
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢) --- */
        .container {
            padding: 10px;
            padding-bottom: 50px;
        }

        /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€š */
        .section-title {
            text-align: center;
            font-size: 16px;
            margin: 10px 0 5px 0;
        }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1px;
            background-color: #000;
            border: 1px solid #444;
        }
        .grid-cell {
            background-color: var(--accent-gray);
            padding: 10px 5px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .grid-cell.dark {
            background-color: #222;
        }
        .label {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 4px;
        }
        .value {
            font-size: 24px;
            font-weight: bold;
        }

        /* ã‚¿ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ (ç°è‰²ã§å¡—ã‚Šã¤ã¶ã•ã‚ŒãŸå…¥åŠ›ã‚¨ãƒªã‚¢) */
        .tap-zone {
            background-color: var(--tap-zone);
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .tap-zone:active {
            background-color: #707070;
        }
        /* ãƒã‚¤ãƒŠã‚¹æ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .tap-zone.decrement-mode {
            background-color: #800000; 
        }

        .single-zone {
            background-color: var(--tap-zone);
            text-align: center;
            padding: 15px;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* ãƒ©ãƒ³ãƒ—ç³»ãƒœã‚¿ãƒ³ */
        .lamp-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            background-color: #444;
            margin-bottom: 10px;
        }
        .lamp-btn {
            background-color: var(--tap-zone);
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        .lamp-label { font-size: 12px; margin-bottom: 5px; }
        .lamp-val { font-size: 20px; }
        
        .l-blue { color: var(--lamp-blue); }
        .l-yellow { color: var(--lamp-yellow); }
        .l-green { color: var(--lamp-green); }
        .l-red { color: var(--lamp-red); }
        .l-rainbow { 
            background: var(--lamp-rainbow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (è¨­å®šãƒ»æ¨æ¸¬) --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-bg);
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 22px; font-weight: bold; }
        .close-btn { font-size: 30px; cursor: pointer; }

        /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ‘ãƒ¼ãƒ„ */
        .input-group { margin-bottom: 15px; }
        .input-label { display: block; margin-bottom: 5px; text-align: center; }
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            font-size: 18px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            text-align: right;
            box-sizing: border-box;
        }
        .action-btn {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            border: 1px solid lime;
            background-color: rgba(0,255,0,0.1);
            color: lime;
            cursor: pointer;
        }
        .reset-btn {
            border-color: red;
            background-color: rgba(255,0,0,0.1);
            color: red;
        }

        /* æ¨æ¸¬ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ‘ãƒ¼ãƒ„ */
        .bar-container {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .bar-label { width: 50px; font-size: 14px; }
        .bar-area { flex-grow: 1; background-color: #333; height: 15px; margin: 0 10px; position: relative; }
        .bar-fill { height: 100%; background-color: white; width: 0%; transition: width 0.5s; }
        .bar-val { width: 50px; text-align: right; font-size: 14px; }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin-top: 20px;
        }
        .detail-table th, .detail-table td {
            padding: 8px;
            border-bottom: 1px solid #444;
        }
        .detail-table th { text-align: left; color: #ccc; }
        .detail-table td { text-align: right; }

        /* ãƒ˜ãƒ«ãƒ‘ãƒ¼ */
        .hidden { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="icon-btn" onclick="openModal('predict-modal')">ğŸ”</div>
        <div class="header-title" id="machine-name-display">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</div>
        <div class="icon-btn" onclick="openModal('setting-modal')">âš™ï¸</div>
    </div>

    <div class="container">
        <div class="section-title">&lt;æ‰“ã¡å§‹ã‚&gt;</div>
        <div class="grid-3">
            <div class="grid-cell dark"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><div class="value" id="disp-start-g">0</div></div>
            <div class="grid-cell dark"><div class="label">BIG</div><div class="value" id="disp-start-big">0</div></div>
            <div class="grid-cell dark"><div class="label">REG</div><div class="value" id="disp-start-reg">0</div></div>
        </div>

        <div class="section-title">&lt;ç¾åœ¨&gt;</div>
        <div class="grid-3">
            <div class="grid-cell tap-zone" id="btn-games" oncontextmenu="return false;">
                <div class="label">ã‚²ãƒ¼ãƒ æ•°</div>
                <div class="value" id="disp-games">0</div>
            </div>
            <div class="grid-cell tap-zone" id="btn-big" oncontextmenu="return false;">
                <div class="label">BIG</div>
                <div class="value" id="disp-big">0</div>
            </div>
            <div class="grid-cell tap-zone" id="btn-reg" oncontextmenu="return false;">
                <div class="label">REG</div>
                <div class="value" id="disp-reg">0</div>
            </div>
        </div>

        <div class="section-title">&lt;é€šå¸¸æ™‚ï¼šãƒ™ãƒ«&gt;</div>
        <div class="single-zone tap-zone" id="btn-bell" oncontextmenu="return false;">
            <span id="disp-bell">0</span>
        </div>

        <div class="section-title">&lt;BIGï¼šã‚¹ã‚¤ã‚«&gt;</div>
        <div class="single-zone tap-zone" id="btn-suika" oncontextmenu="return false;">
            <span id="disp-suika">0</span>
        </div>

        <div class="section-title">&lt;BIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—&gt;</div>
        <div class="lamp-grid">
            <div class="lamp-btn tap-zone" id="btn-big-blue" oncontextmenu="return false;"><div class="lamp-label l-blue">é’</div><div class="lamp-val" id="disp-big-blue">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-big-yellow" oncontextmenu="return false;"><div class="lamp-label l-yellow">é»„</div><div class="lamp-val" id="disp-big-yellow">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-big-green" oncontextmenu="return false;"><div class="lamp-label l-green">ç·‘</div><div class="lamp-val" id="disp-big-green">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-big-red" oncontextmenu="return false;"><div class="lamp-label l-red">èµ¤</div><div class="lamp-val" id="disp-big-red">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-big-rain" oncontextmenu="return false;"><div class="lamp-label l-rainbow">è™¹</div><div class="lamp-val" id="disp-big-rain">0</div></div>
        </div>

        <div class="section-title">&lt;REGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—&gt;</div>
        <div class="lamp-grid">
            <div class="lamp-btn tap-zone" id="btn-reg-blue" oncontextmenu="return false;"><div class="lamp-label l-blue">é’</div><div class="lamp-val" id="disp-reg-blue">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-reg-yellow" oncontextmenu="return false;"><div class="lamp-label l-yellow">é»„</div><div class="lamp-val" id="disp-reg-yellow">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-reg-green" oncontextmenu="return false;"><div class="lamp-label l-green">ç·‘</div><div class="lamp-val" id="disp-reg-green">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-reg-red" oncontextmenu="return false;"><div class="lamp-label l-red">èµ¤</div><div class="lamp-val" id="disp-reg-red">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-reg-rain" oncontextmenu="return false;"><div class="lamp-label l-rainbow">è™¹</div><div class="lamp-val" id="disp-reg-rain">0</div></div>
        </div>
        
        <div class="section-title">&lt;REGï¼šç­ä½“ãƒ©ãƒ³ãƒ—&gt;</div>
        <div class="lamp-grid">
            <div class="lamp-btn tap-zone" id="btn-regtop-blue" oncontextmenu="return false;"><div class="lamp-label l-blue">é’</div><div class="lamp-val" id="disp-regtop-blue">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-regtop-yellow" oncontextmenu="return false;"><div class="lamp-label l-yellow">é»„</div><div class="lamp-val" id="disp-regtop-yellow">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-regtop-green" oncontextmenu="return false;"><div class="lamp-label l-green">ç·‘</div><div class="lamp-val" id="disp-regtop-green">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-regtop-red" oncontextmenu="return false;"><div class="lamp-label l-red">èµ¤</div><div class="lamp-val" id="disp-regtop-red">0</div></div>
            <div class="lamp-btn tap-zone" id="btn-regtop-rain" oncontextmenu="return false;"><div class="lamp-label l-rainbow">è™¹</div><div class="lamp-val" id="disp-regtop-rain">0</div></div>
        </div>

        <div class="section-title">&lt;ãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰&gt;</div>
        <div class="grid-3" style="grid-template-columns: 1fr 1fr;">
            <div class="grid-cell dark"><div class="label">ç™ºç”Ÿæ¡ä»¶é”æˆ</div><div class="value" id="disp-retro-denom">0</div></div>
            <div class="grid-cell tap-zone" id="btn-retro" oncontextmenu="return false;"><div class="label">ç™ºç”Ÿå›æ•°</div><div class="value" id="disp-retro">0</div></div>
        </div>

        <div class="section-title">&lt;BIGï¼šç´”ãƒã‚ºãƒ¬&gt;</div>
        <div class="single-zone tap-zone" id="btn-hazure" oncontextmenu="return false;">
            <span id="disp-hazure">0</span>
        </div>

    </div>

    <div id="setting-modal" class="modal">
        <div class="modal-header">
            <div class="modal-title">è¨­å®š</div>
            <div class="close-btn" onclick="closeModal('setting-modal')">âœ•</div>
        </div>

        <div class="input-group">
            <label class="input-label">&lt;æ©Ÿç¨®é¸æŠ&gt;</label>
            <select id="machine-select" onchange="changeMachine()">
                <option value="king">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
                <option value="newking">ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
            </select>
        </div>

        <div class="input-group">
            <label class="input-label">&lt;æ‰“ã¡å§‹ã‚&gt;</label>
            <label class="label">ã‚²ãƒ¼ãƒ æ•°</label>
            <input type="number" id="input-start-g" placeholder="00000">
        </div>
        <div class="input-group">
            <label class="label">BIG</label>
            <input type="number" id="input-start-big" placeholder="000">
        </div>
        <div class="input-group">
            <label class="label">REG</label>
            <input type="number" id="input-start-reg" placeholder="000">
        </div>

        <button class="action-btn" onclick="saveToSheet()">ãƒ‡ãƒ¼ã‚¿ä¿å­˜ (GAS)</button>
        <button class="action-btn reset-btn" onclick="resetData()">ãƒªã‚»ãƒƒãƒˆ</button>
        <p style="text-align:center; font-size:12px; color:gray;">â€»å…¥åŠ›å€¤å¤‰æ›´æ™‚ã¯Ã—ã‚’æŠ¼ã™ã¨ä¿å­˜ã•ã‚Œã¾ã™</p>
    </div>

    <div id="predict-modal" class="modal">
        <div class="modal-header">
            <div class="modal-title">æ¨æ¸¬</div>
            <div class="close-btn" onclick="closeModal('predict-modal')">âœ•</div>
        </div>

        <div class="section-title">&lt;æ¨æ¸¬è¨­å®š&gt;</div>
        <div id="bars-container">
            </div>

        <div class="section-title">&lt;è©³ç´°&gt;</div>
        <table class="detail-table">
            <tr><th>é€šå¸¸æ™‚å›è»¢æ•°</th><td id="det-games">0å›è»¢</td></tr>
            <tr><th>BIGå›æ•°</th><td id="det-big">0 (1/0.0)</td></tr>
            <tr><th>REGå›æ•°</th><td id="det-reg">0 (1/0.0)</td></tr>
            <tr><th>åˆç®—</th><td id="det-total">1/0.0</td></tr>
            <tr><th>ãƒ™ãƒ«</th><td id="det-bell">0 (1/0.0)</td></tr>
            <tr><th>BIGä¸­ã‚¹ã‚¤ã‚«</th><td id="det-suika">0 (1/0.0)</td></tr>
            <tr><th>BIGå¾Œãƒ‘ãƒãƒ«</th><td id="det-big-panel">...</td></tr>
            <tr><th>REGã‚µã‚¤ãƒ‰</th><td id="det-reg-side">...</td></tr>
        </table>
    </div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let data = {
        machine: 'king',
        start: { g:0, big:0, reg:0 },
        current: {
            g:0, big:0, reg:0, bell:0, suika:0, hazure:0, retro:0,
            bigLamp: [0,0,0,0,0], // é’é»„ç·‘èµ¤è™¹
            regSide: [0,0,0,0,0],
            regTop: [0,0,0,0,0]
        }
    };

    // Google Apps Scriptã®URL (å¾Œã§è‡ªåˆ†ã®ã‚’å…¥ã‚Œã‚‹)
    const GAS_URL = "YOUR_GAS_URL_HERE"; 

    // --- è¨­å®šåˆ¤åˆ¥ç”¨ç¢ºç‡ãƒ‡ãƒ¼ã‚¿ (ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠåŸºæº–) ---
    // â€»ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ç”¨ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚‚å®Ÿè£…å¯ã ãŒä»Šå›ã¯å…±é€šå€¤ã¾ãŸã¯ã‚­ãƒ³ã‚°é‡è¦–
    const PROBS = {
        king: {
            bell: [7.2, 7.15, 7.1, 7.05, 7.0, 6.7], // ãƒ™ãƒ«ç¢ºç‡(ä»®)
            big: [292, 282, 273, 264, 252, 234],
            reg: [489, 455, 422, 399, 368, 336],
            suika: [48, 44, 42, 40, 36, 32], // BIGä¸­ã‚¹ã‚¤ã‚«
            bigLamp: [ // ãƒ•ã‚§ã‚¶ãƒ¼(ãƒˆãƒƒãƒ—) ç¢ºç‡ã§ã¯ãªãé…åˆ†æ¯”ç‡
                [15,10,15,10,0], // 1
                [10,15,10,15,0], // 2
                [15,10,15,10,0], // 3
                [10,15,10,15,0], // 4
                [15,10,15,10,2], // 5
                [12,12,12,12,6]  // 6
            ],
            regSide: [ // ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ— æ¯”ç‡ (é’é»„ç·‘èµ¤è™¹)
                [60, 40, 0, 0, 0], // 1 (å¥‡æ•°å¯„ã‚Š)
                [40, 60, 0, 0, 0], // 2 (å¶æ•°å¯„ã‚Š)
                [50, 30, 15, 5, 0], // 3
                [30, 50, 5, 15, 0], // 4
                [45, 25, 20, 10, 1], // 5
                [25, 25, 25, 25, 5]  // 6 (å‡ç­‰+è™¹)
            ]
        }
    };

    // --- åˆæœŸåŒ– ---
    window.onload = function() {
        loadLocal();
        updateDisplay();
        setupLongPress();
    };

    // --- é•·æŠ¼ã—(ãƒã‚¤ãƒŠã‚¹)ãƒ»ã‚¿ãƒƒãƒ—(ãƒ—ãƒ©ã‚¹)å‡¦ç† ---
    function setupLongPress() {
        const ids = [
            'btn-games', 'btn-big', 'btn-reg', 'btn-bell', 'btn-suika', 
            'btn-big-blue', 'btn-big-yellow', 'btn-big-green', 'btn-big-red', 'btn-big-rain',
            'btn-reg-blue', 'btn-reg-yellow', 'btn-reg-green', 'btn-reg-red', 'btn-reg-rain',
            'btn-regtop-blue', 'btn-regtop-yellow', 'btn-regtop-green', 'btn-regtop-red', 'btn-regtop-rain',
            'btn-retro', 'btn-hazure'
        ];

        ids.forEach(id => {
            let btn = document.getElementById(id);
            let timer;
            let isLong = false;

            // ã‚¿ãƒƒãƒé–‹å§‹
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç­‰ã®å¹²æ¸‰é˜²æ­¢
                isLong = false;
                btn.style.transform = "scale(0.98)";
                
                timer = setTimeout(() => {
                    isLong = true;
                    btn.classList.add('decrement-mode'); // è‰²å¤‰ãˆã‚‹
                    navigator.vibrate(50); // ãƒã‚¤ãƒ–
                }, 500); // 0.5ç§’é•·æŠ¼ã—åˆ¤å®š
            }, {passive: false});

            // ã‚¿ãƒƒãƒçµ‚äº†
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                clearTimeout(timer);
                btn.style.transform = "scale(1)";
                btn.classList.remove('decrement-mode');

                if (isLong) {
                    // ãƒã‚¤ãƒŠã‚¹å‡¦ç†
                    handleCount(id, -1);
                } else {
                    // ãƒ—ãƒ©ã‚¹å‡¦ç†
                    handleCount(id, 1);
                }
            }, {passive: false});
        });
    }

    function handleCount(id, val) {
        const c = data.current;
        // ãƒãƒƒãƒ”ãƒ³ã‚°
        if(id === 'btn-games') c.g += (val * 50); // ã‚²ãƒ¼ãƒ æ•°ã¯50å˜ä½
        if(id === 'btn-big') c.big += val;
        if(id === 'btn-reg') c.reg += val;
        if(id === 'btn-bell') c.bell += val;
        if(id === 'btn-suika') c.suika += val;
        if(id === 'btn-hazure') c.hazure += val;
        if(id === 'btn-retro') c.retro += val;

        // é…åˆ—ç³»
        const mapArr = {
            'btn-big-': { arr: c.bigLamp, idx: ['blue','yellow','green','red','rain'] },
            'btn-reg-': { arr: c.regSide, idx: ['blue','yellow','green','red','rain'] },
            'btn-regtop-': { arr: c.regTop, idx: ['blue','yellow','green','red','rain'] }
        };

        for(let key in mapArr) {
            if(id.startsWith(key)) {
                let color = id.replace(key, '');
                let index = mapArr[key].idx.indexOf(color);
                if(index >= 0) mapArr[key].arr[index] += val;
            }
        }

        // è² ã®æ•°é˜²æ­¢
        if(c.g < 0) c.g = 0;
        // ä»–ã‚‚å¿…è¦ãªã‚‰ãƒã‚§ãƒƒã‚¯

        saveLocal();
        updateDisplay();
    }

    // --- è¡¨ç¤ºæ›´æ–° ---
    function updateDisplay() {
        const c = data.current;
        const s = data.start;

        // æ‰“ã¡å§‹ã‚
        document.getElementById('disp-start-g').innerText = s.g;
        document.getElementById('disp-start-big').innerText = s.big;
        document.getElementById('disp-start-reg').innerText = s.reg;
        
        // ç¾åœ¨
        document.getElementById('disp-games').innerText = c.g;
        document.getElementById('disp-big').innerText = c.big;
        document.getElementById('disp-reg').innerText = c.reg;
        document.getElementById('disp-bell').innerText = c.bell;
        document.getElementById('disp-suika').innerText = c.suika;
        document.getElementById('disp-hazure').innerText = c.hazure;
        document.getElementById('disp-retro').innerText = c.retro;
        
        // ãƒ¬ãƒˆãƒ­ç™ºç”Ÿæ¡ä»¶ (BIGé€£ãƒãƒ£ãƒ³æ•°ç­‰ã®æ¦‚ç®—ã§ã¯ãªãå˜ç´”ã«BIGå›æ•°ã‚’å…¥ã‚Œã‚‹ã‹ã€ä¾¿å®œä¸ŠBIGå›æ•°ã‚’è¡¨ç¤º)
        // â€»å³å¯†ã«ã¯87Gä»¥å†…BIGã ãŒã€ã“ã“ã§ã¯BIGå›æ•°ã‚’åˆ†æ¯ã¨ã—ã¦ãŠã
        document.getElementById('disp-retro-denom').innerText = c.big; 

        // ãƒ©ãƒ³ãƒ—ç³»
        const colors = ['blue','yellow','green','red','rain'];
        colors.forEach((col, i) => {
            document.getElementById('btn-big-'+col).querySelector('.lamp-val').innerText = c.bigLamp[i];
            document.getElementById('btn-reg-'+col).querySelector('.lamp-val').innerText = c.regSide[i];
            document.getElementById('btn-regtop-'+col).querySelector('.lamp-val').innerText = c.regTop[i];
        });

        // æ©Ÿç¨®å
        document.getElementById('machine-name-display').innerText = 
            (data.machine === 'king') ? 'ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ' : 'ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ';
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    function openModal(id) {
        if(id === 'setting-modal') {
            document.getElementById('machine-select').value = data.machine;
            document.getElementById('input-start-g').value = data.start.g;
            document.getElementById('input-start-big').value = data.start.big;
            document.getElementById('input-start-reg').value = data.start.reg;
        }
        if(id === 'predict-modal') {
            calculatePredict();
        }
        document.getElementById(id).style.display = 'block';
    }

    function closeModal(id) {
        if(id === 'setting-modal') {
            // å€¤ã‚’åæ˜ 
            data.machine = document.getElementById('machine-select').value;
            data.start.g = Number(document.getElementById('input-start-g').value);
            data.start.big = Number(document.getElementById('input-start-big').value);
            data.start.reg = Number(document.getElementById('input-start-reg').value);
            saveLocal();
            updateDisplay();
        }
        document.getElementById(id).style.display = 'none';
    }

    function changeMachine() {
        data.machine = document.getElementById('machine-select').value;
    }

    function resetData() {
        if(confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
            data.current = {
                g:0, big:0, reg:0, bell:0, suika:0, hazure:0, retro:0,
                bigLamp: [0,0,0,0,0], regSide: [0,0,0,0,0], regTop: [0,0,0,0,0]
            };
            saveLocal();
            updateDisplay();
            closeModal('setting-modal');
        }
    }

    // --- ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ ---
    function saveLocal() {
        localStorage.setItem('hana_counter_data', JSON.stringify(data));
    }
    function loadLocal() {
        const saved = localStorage.getItem('hana_counter_data');
        if(saved) {
            data = JSON.parse(saved);
        }
    }

    // --- æ¨æ¸¬ãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“ãƒ™ã‚¤ã‚º) ---
    function calculatePredict() {
        // ç¾åœ¨å€¤
        const G = data.current.g;
        const BIG = data.current.big;
        const REG = data.current.reg;
        const BELL = data.current.bell;
        const SUIKA = data.current.suika;
        // ãƒ©ãƒ³ãƒ—ç­‰ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ä»Šå›ã¯ã€Œãƒ™ãƒ«ãƒ»BIGãƒ»REGãƒ»ã‚¹ã‚¤ã‚«ã€ã‚’ä¸»è»¸ã«è¨ˆç®—
        
        let likelihood = [1,1,1,1,1,1]; // è¨­å®š1-6ã®å°¤åº¦
        const p = PROBS.king; // ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨

        for(let i=0; i<6; i++) {
            // ãƒ™ãƒ«ç¢ºç‡ (äºŒé …åˆ†å¸ƒè¿‘ä¼¼)
            if(G > 0 && BELL > 0) {
                let bellProb = 1 / p.bell[i];
                likelihood[i] *= Math.pow(bellProb, BELL) * Math.pow(1-bellProb, G - BELL);
            }
            // BIGç¢ºç‡
            if(G > 0) {
                let bigProb = 1 / p.big[i];
                likelihood[i] *= Math.pow(bigProb, BIG) * Math.pow(1-bigProb, G - BIG);
            }
            // REGç¢ºç‡
            if(G > 0) {
                let regProb = 1 / p.reg[i];
                likelihood[i] *= Math.pow(regProb, REG) * Math.pow(1-regProb, G - REG);
            }
            // BIGä¸­ã‚¹ã‚¤ã‚«
            if(BIG > 0) {
                // BIG1å›ã‚ãŸã‚Š24Gã¨ä»®å®š
                let bigG = BIG * 24; 
                let suikaProb = 1 / p.suika[i];
                likelihood[i] *= Math.pow(suikaProb, SUIKA) * Math.pow(1-suikaProb, bigG - SUIKA);
            }
            
            // æ•°å€¤ãŒå°ã•ããªã‚Šã™ãã‚‹ã®ã‚’é˜²ãæ­£è¦åŒ–(å¯¾æ•°ãªã©ä½¿ã†ã®ãŒæ­£è§£ã ãŒç°¡æ˜“çš„ã«)
            if(likelihood[i] < 1e-100) likelihood[i] *= 1e100;
        }

        // åˆè¨ˆ
        let sum = likelihood.reduce((a,b)=>a+b, 0);
        let percent = likelihood.map(v => (v/sum)*100);
        let maxVal = Math.max(...percent);

        // è¡¨ç¤ºç”Ÿæˆ
        let html = '';
        for(let i=0; i<6; i++) {
            let width = (percent[i] / maxVal) * 100; // æœ€å¤§å€¤ã‚’100%ã¨ã—ãŸç›¸å¯¾å¹…
            if(isNaN(width)) width = 0;
            html += `
                <div class="bar-container">
                    <div class="bar-label">è¨­å®š${i+1}</div>
                    <div class="bar-area"><div class="bar-fill" style="width:${width}%"></div></div>
                    <div class="bar-val">${percent[i].toFixed(1)}%</div>
                </div>
            `;
        }
        document.getElementById('bars-container').innerHTML = html;

        // è©³ç´°ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        document.getElementById('det-games').innerText = G + "å›è»¢";
        document.getElementById('det-big').innerText = `${BIG}å› (1/${(G/BIG).toFixed(1)})`;
        document.getElementById('det-reg').innerText = `${REG}å› (1/${(G/REG).toFixed(1)})`;
        document.getElementById('det-bell').innerText = `${BELL}å› (1/${(G/BELL).toFixed(1)})`;
        document.getElementById('det-suika').innerText = `${SUIKA}å› (1/${(BIG*24/SUIKA).toFixed(1)})`;
    }

    // --- Google Sheetsé€£æº ---
    function testSave() {
    fetch(GAS_URL === "https://script.google.com/macros/s/AKfycbxG7of3ZnUZAEtdGJSm6Mps-gW-MbTKBuBYfKsR5YDMS6-wDU5J9S9QexoQ6Xp5zsNl/exec", {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({test: 'hello'})
    })
    .then(() => alert('é€ä¿¡æˆåŠŸ'))
    .catch(err => alert('ã‚¨ãƒ©ãƒ¼: ' + err));
}

</script>
</body>
</html>

