<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HANA Counter Ultimate</title>
    <style>
        :root {
            --bg-color: #1a1a1a; /* å…¨ä½“ã®èƒŒæ™¯ */
            --cell-bg: #444444; /* ãƒœã‚¿ãƒ³ã®èƒŒæ™¯è‰²ï¼ˆç”»åƒã«åˆã‚ã›å¤‰æ›´ï¼‰ */
            --grid-gap: 1px;    /* ã‚°ãƒªãƒƒãƒ‰ã®éš™é–“ */
            --grid-line: #111111; /* éš™é–“ã®è‰² */
            --text-white: #ffffff;
            --text-label: #cccccc; /* ãƒ©ãƒ™ãƒ«ã®è‰² */
            /* ãƒ©ãƒ³ãƒ—è‰² */
            --lamp-blue: #0099ff;
            --lamp-yellow: #ffcc00;
            --lamp-green: #00cc00;
            --lamp-red: #ff3333;
        }

        html, body {
            background: var(--bg-color); color: var(--text-white);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 0; -webkit-text-size-adjust: 100%;
            user-select: none; -webkit-user-select: none;
            touch-action: pan-y; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ã¿è¨±å¯ */
        }

        /* è™¹è‰²ãƒ†ã‚­ã‚¹ãƒˆï¼ˆç”»åƒã«è¿‘ã„ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
        .rainbow {
            background: linear-gradient(to right, #ff0000, #ff9900, #ffff00, #33ff00, #00ffff, #0033ff, #9900ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: var(--bg-color);
            position: sticky; top: 0; z-index: 100;
        }
        .header-icon { font-size: 22px; padding: 5px; cursor: pointer; }
        .header-title { font-size: 18px; font-weight: bold; border-bottom: 2px solid var(--text-white); padding-bottom: 2px; }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .container { padding: 5px 10px 80px 10px; }
        .section-title { text-align: center; margin: 20px 0 5px; font-size: 14px; color: var(--text-label); }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆéš™é–“ã§ç·šã‚’è¡¨ç¾ï¼‰ */
        .grid { display: grid; gap: var(--grid-gap); background: var(--grid-line); border: var(--grid-gap) solid var(--grid-line); margin-bottom: 15px; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        
        /* ã‚»ãƒ«ï¼ˆãƒœã‚¿ãƒ³ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³å®Œå…¨å†ç¾ */
        .cell {
            background: var(--cell-bg); padding: 15px 5px; text-align: center;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: 50px; /* é«˜ã•ç¢ºä¿ */
        }
        .label { font-size: 12px; color: var(--text-label); margin-bottom: 5px; pointer-events: none; }
        .value { font-size: 24px; font-weight: bold; line-height: 1; pointer-events: none; }

        /* ã‚¿ãƒƒãƒ—æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        .touch-active { background: #666666 !important; } /* ã‚¿ãƒƒãƒ—ä¸­ */
        .minus-mode { background: #990000 !important; transition: background 0.2s; } /* é•·æŠ¼ã—ãƒã‚¤ãƒŠã‚¹ãƒ¢ãƒ¼ãƒ‰ */

        /* æ•°å€¤å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .val-input {
            width: 100%; background: transparent; color: var(--text-white); border: none;
            text-align: center; font-size: 24px; font-weight: bold; outline: none; padding: 0;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…¨ç”»é¢è¡¨ç¤ºï¼‰ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20,20,20,0.98); z-index: 200; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: var(--bg-color); position: sticky; top:0;
        }
        .modal-title { font-size: 18px; font-weight: bold; text-align: center; flex-grow: 1; }
        .close-btn { font-size: 24px; padding: 5px; cursor: pointer; color: #ccc; }
        .modal-body { padding: 20px 15px; max-width: 600px; margin: 0 auto; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®è¦ç´  */
        .switch-btn {
            width: 100%; padding: 12px; background: #333; color: #fff; border: 1px solid #555;
            font-size: 16px; margin: 10px 0 20px; cursor: pointer;
        }
        select.machine-select {
            width: 100%; padding: 12px; background: #333; color: #fff; border: 1px solid #555;
            font-size: 16px; margin: 5px 0 20px; border-radius: 0; -webkit-appearance: none;
        }
        .action-btn {
            width: 100%; padding: 15px; font-size: 16px; font-weight: bold;
            margin-top: 20px; cursor: pointer; border: none;
        }
        .btn-green { background: rgba(0,200,0,0.2); color: #0f0; border: 1px solid #0f0; }
        .btn-red { background: rgba(200,0,0,0.2); color: #f00; border: 1px solid #f00; }

        /* æ¨æ¸¬ãƒãƒ¼ */
        .bar-row { display: flex; align-items: center; margin: 12px 0; font-size: 14px; }
        .bar-label { width: 50px; }
        .bar-bg { flex: 1; height: 10px; background: #333; margin: 0 15px; }
        .bar-fill { height: 100%; background: #fff; width: 0%; transition: width 0.5s ease-out; }
        .bar-val { width: 50px; text-align: right; }

        /* è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« */
        .detail-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px; }
        .detail-table th { background: #2a2a2a; color: #ccc; font-weight: normal; text-align: left; padding: 8px; border-bottom: 1px solid #444; }
        .detail-table td { padding: 8px; border-bottom: 1px solid #444; text-align: right; }
        .lamp-detail span { margin-left: 5px; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-icon" onclick="openModal('predict-modal')">ğŸ”</div>
    <div class="header-title" id="disp-machine">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</div>
    <div class="header-icon" onclick="openModal('setting-modal')">âš™ï¸</div>
</div>

<div class="container" id="main-ui">
    </div>

<div id="setting-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div>
        <div class="modal-title">è¨­å®š</div>
        <div class="close-btn" onclick="closeModal('setting-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title">ï¼œæ©Ÿç¨®é¸æŠï¼</p>
        <select id="machine-select" class="machine-select" onchange="updateMachine()">
            <option value="king">ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
            <option value="new">ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ</option>
        </select>

        <p class="section-title">ï¼œå…¥åŠ›åˆ‡ã‚Šæ›¿ãˆï¼</p>
        <button id="mode-toggle" class="switch-btn" onclick="toggleMode()">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å…¥åŠ›</button>

        <p class="section-title">ï¼œæ‰“ã¡å§‹ã‚ï¼</p>
        <div class="grid grid-3">
            <div class="cell"><div class="label">ã‚²ãƒ¼ãƒ æ•°</div><input type="number" class="val-input" id="start-g" onchange="saveData()"></div>
            <div class="cell"><div class="label">BIG</div><input type="number" class="val-input" id="start-b" onchange="saveData()"></div>
            <div class="cell"><div class="label">REG</div><input type="number" class="val-input" id="start-r" onchange="saveData()"></div>
        </div>

        <button class="action-btn btn-green" onclick="closeModal('setting-modal')">ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
        <button class="action-btn btn-red" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
</div>

<div id="predict-modal" class="modal">
    <div class="modal-header">
        <div style="width:24px;"></div>
        <div class="modal-title">æ¨æ¸¬</div>
        <div class="close-btn" onclick="closeModal('predict-modal')">âœ•</div>
    </div>
    <div class="modal-body">
        <p class="section-title">ï¼œæ¨æ¸¬è¨­å®šï¼</p>
        <div id="predict-bars-area"></div>

        <p class="section-title">ï¼œè©³ç´°ï¼</p>
        <table class="detail-table" id="detail-table-body">
            </table>
    </div>
</div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let data = JSON.parse(localStorage.getItem('hana_ultimate_data')) || {
        machine: 'king', mode: 'tap',
        start: { g:0, b:0, r:0 },
        cur: { g:0, b:0, r:0, bell:0, suika:0, hazure:0, retro_d:0, retro:0 },
        lamps: { big: [0,0,0,0,0], regS: [0,0,0,0,0], regT: [0,0,0,0,0] }
    };

    // --- è§£æå€¤ (ä»®) ---
    const PROBS = {
        king: { b:[292,282,273,264,252,234], r:[489,455,422,399,368,336], bell:[7.2,7.15,7.1,7.05,7,6.7] }
    };

    // --- åˆæœŸåŒ–ï¼†ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ---
    function init() {
        document.getElementById('machine-select').value = data.machine;
        updateMachineView();
        document.getElementById('mode-toggle').innerText = data.mode === 'tap' ? 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å…¥åŠ›' : 'æ•°å€¤å…¥åŠ›';
        document.getElementById('start-g').value = data.start.g;
        document.getElementById('start-b').value = data.start.b;
        document.getElementById('start-r').value = data.start.r;
        renderUI();
    }

    function saveData() {
        data.start.g = Number(document.getElementById('start-g').value);
        data.start.b = Number(document.getElementById('start-b').value);
        data.start.r = Number(document.getElementById('start-r').value);
        data.machine = document.getElementById('machine-select').value;
        localStorage.setItem('hana_ultimate_data', JSON.stringify(data));
        renderUI();
    }

    function updateMachine() { saveData(); updateMachineView(); }
    function updateMachineView() { document.getElementById('disp-machine').innerText = data.machine === 'king' ? 'ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ' : 'ãƒ‹ãƒ¥ãƒ¼ã‚­ãƒ³ã‚°ãƒãƒŠãƒãƒŠ'; }
    function toggleMode() {
        data.mode = data.mode === 'tap' ? 'input' : 'tap';
        document.getElementById('mode-toggle').innerText = data.mode === 'tap' ? 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å…¥åŠ›' : 'æ•°å€¤å…¥åŠ›';
        saveData();
    }

    // --- UIç”Ÿæˆ ---
    function renderUI() {
        const c = data.cur;
        const isInput = data.mode === 'input';
        const html = `
            <p class="section-title">ï¼œç¾åœ¨ï¼</p>
            <div class="grid grid-3">${mkCell('g','ã‚²ãƒ¼ãƒ æ•°',c.g,50)} ${mkCell('b','BIG',c.b)} ${mkCell('r','REG',c.r)}</div>
            <p class="section-title">ï¼œé€šå¸¸æ™‚ï¼šãƒ™ãƒ«ï¼</p><div class="grid">${mkCell('bell','',c.bell)}</div>
            <p class="section-title">ï¼œBIGï¼šã‚¹ã‚¤ã‚«ï¼</p><div class="grid">${mkCell('suika','',c.suika)}</div>
            <p class="section-title">ï¼œBIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkLamps('big')}</div>
            <p class="section-title">ï¼œREGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkLamps('regS')}</div>
            <p class="section-title">ï¼œREGï¼šç­ä½“ãƒ©ãƒ³ãƒ—ï¼</p><div class="grid grid-5">${mkLamps('regT')}</div>
            <p class="section-title">ï¼œãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰ï¼</p>
            <div class="grid grid-2">${mkCell('retro_d','ç™ºç”Ÿæ¡ä»¶é”æˆ',c.retro_d)} ${mkCell('retro','ç™ºç”Ÿå›æ•°',c.retro)}</div>
            <p class="section-title">ï¼œBIGï¼šç´”ãƒã‚ºãƒ¬ï¼</p><div class="grid">${mkCell('hazure','',c.hazure)}</div>
        `;
        document.getElementById('main-ui').innerHTML = html;
        if(!isInput) attachTouchEvents();
    }

    function mkCell(id, label, val, step=1) {
        if(data.mode === 'input') return `<div class="cell"><div class="label">${label}</div><input type="number" class="val-input" value="${val}" onchange="data.cur.${id}=Number(this.value);saveData();"></div>`;
        return `<div class="cell touch-target" data-id="${id}" data-step="${step}"><div class="label">${label}</div><div class="value">${val}</div></div>`;
    }
    function mkLamps(type) {
        const labels = ['é’','é»„','ç·‘','èµ¤','è™¹'];
        const colors = ['var(--lamp-blue)','var(--lamp-yellow)','var(--lamp-green)','var(--lamp-red)','rainbow'];
        return labels.map((lbl, i) => {
            const val = data.lamps[type][i];
            const colorStyle = colors[i] === 'rainbow' ? 'class="rainbow"' : `style="color:${colors[i]}"`;
            if(data.mode === 'input') return `<div class="cell"><div class="label" ${colorStyle}>${lbl}</div><input type="number" class="val-input" value="${val}" onchange="data.lamps.${type}[${i}]=Number(this.value);saveData();"></div>`;
            return `<div class="cell touch-target" data-type="${type}" data-idx="${i}"><div class="label" ${colorStyle}>${lbl}</div><div class="value">${val}</div></div>`;
        }).join('');
    }

    // --- ã€é‡è¦ã€‘ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾ç­–æ¸ˆã¿ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ ---
    function attachTouchEvents() {
        document.querySelectorAll('.touch-target').forEach(el => {
            let timer, startY, startX, isScrolling;
            
            el.addEventListener('touchstart', e => {
                startY = e.touches[0].clientY; startX = e.touches[0].clientX;
                isScrolling = false;
                el.classList.add('touch-active');
                timer = setTimeout(() => { if(!isScrolling) el.classList.add('minus-mode'); }, 500);
            }, {passive: true});

            el.addEventListener('touchmove', e => {
                if(isScrolling) return;
                const diffY = Math.abs(e.touches[0].clientY - startY);
                const diffX = Math.abs(e.touches[0].clientX - startX);
                if(diffY > 5 || diffX > 5) { // 5pxä»¥ä¸Šå‹•ã„ãŸã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã¿ãªã™
                    isScrolling = true;
                    clearTimeout(timer);
                    el.classList.remove('touch-active', 'minus-mode');
                }
            }, {passive: true});

            el.addEventListener('touchend', e => {
                clearTimeout(timer);
                if(isScrolling) { el.classList.remove('touch-active', 'minus-mode'); return; }

                const isMinus = el.classList.contains('minus-mode');
                el.classList.remove('touch-active', 'minus-mode');
                
                const step = Number(el.dataset.step || 1);
                const val = isMinus ? -step : step;
                if(el.dataset.id) data.cur[el.dataset.id] += val;
                else data.lamps[el.dataset.type][el.dataset.idx] += val;
                saveData();
            }, {passive: true});
        });
    }

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼†è¨ˆç®— ---
    function openModal(id) { document.getElementById(id).style.display = 'block'; if(id.includes('predict')) calc(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function resetAll() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

    function getProb(n, d) { return (n<=0 || d<=0) ? "(0/0)" : `(1/${(d/n).toFixed(1)})`; }
    function calc() {
        const s = data.start; const c = data.cur;
        const totalG = s.g + c.g; const totalB = s.b + c.b; const totalR = s.r + c.r;
        
        // æ¨æ¸¬ãƒãƒ¼è¨ˆç®—ï¼ˆç°¡æ˜“ï¼‰
        let likeli = [1,1,1,1,1,1]; const p = PROBS[data.machine];
        for(let i=0; i<6; i++) {
            if(c.g>0) {
                likeli[i] *= Math.pow(1/p.b[i], c.b) * Math.pow(1-1/p.b[i], c.g-c.b);
                likeli[i] *= Math.pow(1/p.r[i], c.r) * Math.pow(1-1/p.r[i], c.g-c.r);
                likeli[i] *= Math.pow(1/p.bell[i], c.bell) * Math.pow(1-1/p.bell[i], c.g-c.bell);
            }
        }
        const sum = likeli.reduce((a,b)=>a+b,0) || 1;
        const probs = likeli.map(v=>(v/sum)*100);
        const max = Math.max(...probs) || 1;

        document.getElementById('predict-bars-area').innerHTML = probs.map((v,i)=>`
            <div class="bar-row"><div class="bar-label">è¨­å®š${i+1}</div><div class="bar-bg"><div class="bar-fill" style="width:${(v/max)*100}%"></div></div><div class="bar-val">${v.toFixed(1)}%</div></div>
        `).join('');

        // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
        const l = data.lamps;
        const lampStr = (arr, style) => arr.map((v,i)=>{
            const col = ['#0099ff','#ffcc00','#00cc00','#ff3333','rainbow'][i];
            const cls = col==='rainbow'?'class="rainbow"':`style="color:${col}"`;
            return `<span ${cls}>${['é’','é»„','ç·‘','èµ¤','è™¹'][i]}:${v}</span>`;
        }).join(' ');

        document.getElementById('detail-table-body').innerHTML = `
            <tr><th>é€šå¸¸æ™‚å›è»¢æ•°</th><td>${totalG}å›è»¢</td></tr>
            <tr><th>ãƒœãƒ¼ãƒŠã‚¹å›è»¢æ•°</th><td>${totalB+totalR}å›è»¢</td></tr>
            <tr><th>BIGå›æ•°</th><td>${totalB}å› ${getProb(totalB, totalG)}</td></tr>
            <tr><th>REGå›æ•°</th><td>${totalR}å› ${getProb(totalR, totalG)}</td></tr>
            <tr><th>é€šå¸¸æ™‚ï¼šãƒ™ãƒ«</th><td>${c.bell}å› ${getProb(c.bell, c.g)}</td></tr>
            <tr><th>BIGï¼šã‚¹ã‚¤ã‚«</th><td>${c.suika}å› ${getProb(c.suika, c.b*24)}</td></tr>
            <tr><th>BIGï¼šç­ä½“ãƒ©ãƒ³ãƒ—</th><td class="lamp-detail">${lampStr(l.big)}</td></tr>
            <tr><th>REGï¼šã‚µã‚¤ãƒ‰ãƒ©ãƒ³ãƒ—</th><td class="lamp-detail">${lampStr(l.regS)}</td></tr>
            <tr><th>REGï¼šç­ä½“ãƒ©ãƒ³ãƒ—</th><td class="lamp-detail">${lampStr(l.regT)}</td></tr>
            <tr><th>ãƒ¬ãƒˆãƒ­ã‚µã‚¦ãƒ³ãƒ‰</th><td>${c.retro}å› (${c.retro}/${c.retro_d})</td></tr>
            <tr><th>BIGï¼šç´”ãƒã‚ºãƒ¬</th><td>${c.hazure}å› ${getProb(c.hazure, c.b*24)}</td></tr>
        `;
    }

    init();
</script>
</body>
</html>
